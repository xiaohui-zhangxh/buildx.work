<div class="mb-6">
  <h1 class="text-3xl font-bold">操作日志</h1>
  <p class="text-base-content/60">查看系统中的所有操作记录</p>
</div>

<!-- Search and Filter Form -->
<div class="card bg-base-100 shadow mb-6">
  <div class="card-body">
    <%= form_with url: admin_audit_logs_path, method: :get, local: true, class: "space-y-4" do |form| %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="form-control">
          <%= form.label :search, "搜索（用户/操作/资源）", class: "label" %>
          <%= form.text_field :search, value: params[:search], placeholder: "输入关键词...", class: "input input-bordered" %>
        </div>
        <div class="form-control">
          <%= form.label :action_filter, "操作类型", class: "label" %>
          <%= form.select :action_filter, options_for_select([["全部", ""], ["创建", "create"], ["更新", "update"], ["删除", "destroy"], ["登录", "login"], ["退出", "logout"]], params[:action_filter]), {}, { class: "select select-bordered" } %>
        </div>
        <div class="form-control">
          <%= form.label :resource_type, "资源类型", class: "label" %>
          <%= form.select :resource_type, options_for_select([["全部", ""], ["User", "User"], ["Role", "Role"], ["SystemConfig", "SystemConfig"]], params[:resource_type]), {}, { class: "select select-bordered" } %>
        </div>
        <div class="form-control">
          <%= form.label :start_date, "开始日期", class: "label" %>
          <%= form.date_field :start_date, value: params[:start_date], class: "input input-bordered" %>
        </div>
        <div class="form-control">
          <%= form.label :end_date, "结束日期", class: "label" %>
          <%= form.date_field :end_date, value: params[:end_date], class: "input input-bordered" %>
        </div>
      </div>
      <div class="flex gap-2">
        <%= form.submit "搜索", class: "btn btn-primary" %>
        <%= link_to "重置", admin_audit_logs_path, class: "btn btn-ghost" %>
        <%= link_to "导出CSV", admin_audit_logs_path(format: :csv, params: request.query_parameters), class: "btn btn-outline" %>
      </div>
    <% end %>
  </div>
</div>

<div class="card bg-base-100 shadow">
  <div class="card-body">
    <div class="overflow-x-auto">
      <table class="table">
        <thead>
          <tr>
            <th>时间</th>
            <th>用户</th>
            <th>操作</th>
            <th>资源</th>
            <th>IP地址</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <% if @audit_logs.any? %>
            <% @audit_logs.each do |log| %>
              <tr>
                <td><%= log.created_at.strftime("%Y-%m-%d %H:%M:%S") %></td>
                <td><%= log.user.email_address %></td>
                <td><span class="badge badge-outline"><%= log.action %></span></td>
                <td>
                  <% if log.resource_type.present? %>
                    <%= log.resource_type %> #<%= log.resource_id %>
                  <% else %>
                    -
                  <% end %>
                </td>
                <td><%= log.ip_address || "-" %></td>
                <td>
                  <%= link_to "查看", admin_audit_log_path(log), class: "btn btn-sm btn-ghost" %>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="6" class="text-center text-base-content/60">暂无日志</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

