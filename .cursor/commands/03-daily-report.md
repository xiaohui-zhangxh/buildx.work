# 生成每日工作报告

> 通用指令：记录项目开发进度，回顾今天的工作内容，生成员工日报

## 📋 指令说明

通用指令，用于在工作结束时记录项目开发进度、回顾今天的工作内容，生成员工日报并附加到日报文件中。

**重要**：每次执行此指令时，如果是首次对话，会先检查从上次日报日期到昨天之间的所有日期是否都有日报。如果缺失，会询问是否要补写。补写完成后或没有缺失，才会继续生成今天的日报。

### 使用方式

**Cursor 斜线命令**：`/daily-report`  
**直接描述**：`记录进度，更新统计，结束今天的工作` 或 `生成日报` 或 `结束今天的工作`

## 🔍 工作流程

### 步骤0：检查缺失的日报（重要，每次执行指令时都会检查）

**重要**：每次执行日报指令时，如果是首次对话，必须先检查从上次日报日期到昨天之间的所有日期是否都有日报。如果缺失，需要提醒补写。

**必须执行**：
1. **判断是否为首次对话**：判断当前是否为首次对话
2. **如果是首次对话**：
   - **先阅读规则文件**：必须完整阅读 `.cursor/rules/check-missing-daily-report.mdc` 规则文件
   - **按照规则执行**：严格按照规则文件中的检查流程执行所有步骤
   - **检查缺失的日报**：检查从上次日报日期到昨天之间的所有日期是否都有日报
   - **如果有缺失**：明确提醒员工并询问是否现在补写
   - **如果员工确认补写**：按日期顺序（从早到晚）依次补写所有缺失的日报
   - **补写完成后或没有缺失**：继续执行今天的工作流程
3. **如果不是首次对话**：跳过此检查，直接执行步骤1

**规则文件位置**：`.cursor/rules/check-missing-daily-report.mdc`

**简要说明**：
- 获取员工身份和昨天日期
- 检查从上次日报日期到昨天之间的所有日期是否都有日报
- 如果缺失，明确提醒员工并询问是否现在补写
- 如果员工确认补写，按日期顺序（从早到晚）依次补写所有缺失的日报
- 补写完成后或没有缺失，继续执行今天的工作流程

**详细流程、技术细节、使用示例**：请参考规则文件 `.cursor/rules/check-missing-daily-report.mdc`

**注意**：
- 此检查仅在首次对话时执行，非首次对话时跳过
- 如果有缺失的日报，必须明确提醒员工，列出所有缺失的日期，不能忽略
- 如果员工选择稍后补写，应该尊重其选择，但要在下次首次对话时再次提醒
- 补写日报时，使用与生成今天日报相同的流程，只是日期不同

### 步骤1：获取当前操作者信息

获取当前操作者信息，用于生成员工日报和查询 Git 提交历史：

1. **获取 Git 用户信息**：
   - 使用 `git config user.name` 获取用户名
   - 使用 `git config user.email` 获取用户邮箱
2. **确定员工身份**：
   - 如果 Git 配置中有用户信息，使用该信息
   - 如果 Git 配置为空，提示用户输入员工姓名
3. **验证 Git 提交历史中的身份**：
   - 使用 `git log -1 --pretty=format:"%an|%ae"` 查看最近一次提交的作者信息
   - 如果 Git 配置与提交历史中的作者不一致，优先使用提交历史中的作者信息（因为提交历史更准确）
   - 如果存在多个作者身份，使用提交历史中出现最多的作者信息

### 步骤2：回顾今天的工作内容

回顾今天完成的工作，为生成日报做准备。**重要**：主要通过 Git 提交历史追踪工作，这是最准确的方法。

1. **获取今天日期和时间范围**：
   - 使用系统命令获取当前日期（格式：`YYYY-MM-DD`）
   - 确定时间范围：今天 00:00:00 到 23:59:59

2. **分析 Git 提交历史（主要方法）**：
   - **获取当天所有提交**：
     - 使用 `git log --author="[员工姓名]" --since="[今天] 00:00:00" --until="[今天] 23:59:59" --pretty=format:"%H|%an|%ae|%ad|%s" --date=iso` 获取当天所有提交
     - 如果 Git 配置中的姓名与提交作者不一致，使用 `git log --author="[Git配置的姓名或邮箱]"` 或 `git log --all --author="[Git配置的姓名或邮箱]"` 匹配
   - **分析每个提交**：
     - 提取提交哈希、作者、提交时间、提交信息
     - 使用 `git show --stat [提交哈希]` 查看提交的文件变更
     - 使用 `git diff --stat [提交哈希]^..[提交哈希]` 查看文件变更统计
   - **按工作类型分类提交**：
     - 根据文件路径判断工作类型（功能开发、测试、文档、配置等）
     - 统计每种工作类型的提交数量
     - 提取关键文件变更（新增、修改、删除的文件）

3. **分析文件修改记录（补充方法）**：
   - **查找当天修改的文件**：
     - 使用 `git log --since="[今天] 00:00:00" --until="[今天] 23:59:59" --name-only --pretty=format:"" --author="[员工姓名]" | sort -u` 获取当天修改的所有文件
   - **分析文件类型**：
     - 识别文件类型（控制器、模型、视图、测试、文档、配置等）
     - 根据文件路径和名称推断工作内容
   - **统计文件变更**：
     - 统计新增文件数量
     - 统计修改文件数量
     - 统计删除文件数量

4. **结合项目进度文件（补充信息）**：
   - **读取 CURRENT_WORK.md**：
     - 读取 `CURRENT_WORK.md` 了解当前工作状态
     - 提取今天完成的任务和下一步计划
   - **读取阶段进度文件**：
     - 检查各阶段的 `progress.md`（如 `docs/phase-1-authentication/progress.md`、`docs/phase-2-authorization/progress.md` 等）
     - 查找今天完成的任务（通过完成日期或状态变化）
     - 提取任务详情（任务名称、阶段、分类等）
   - **读取阶段笔记文件**：
     - 检查各阶段的 `notes.md`（如 `docs/phase-1-authentication/notes.md` 等）
     - 提取今天记录的技术决策和问题解决方案

5. **检查测试覆盖率**：
   - **读取覆盖率数据**：
     - 读取 `coverage/.resultset.json` 获取详细覆盖率数据
     - 读取 `coverage/.last_run.json` 获取整体覆盖率信息
   - **分析覆盖率变化**：
     - 对比今天的覆盖率与之前的覆盖率（如有记录）
     - 记录新增的测试用例数量
     - 记录覆盖率提升情况

6. **汇总今天的工作**：
   - **按工作类型分类**：
     - 根据 Git 提交的文件路径，按工作类型分类整理工作（功能开发、测试、文档、配置等）
     - 统计每种工作类型的提交数量、文件变更数量
   - **提取关键工作**：
     - 从提交信息中提取关键工作内容
     - 识别完成的功能（如新功能、功能改进、Bug 修复等）
     - 识别完成的测试（如新增测试用例、测试覆盖率提升等）
     - 识别完成的文档（如更新开发文档、更新进度文件等）
     - 记录文件创建、修改、删除情况
   - **记录统计数据变化**：
     - 结合进度文件，记录项目统计数据变化
     - 记录完成的任务数量、进度变化等
     - 记录测试覆盖率变化

### 步骤3：生成员工日报

生成员工日报并附加到日报文件中：

1. **确定日报文件路径**：
   - **文件命名规则**：按年月归档，格式为 `daily-reports/[员工姓名]-[年份]-[月份].md`
   - **当前年月文件**：根据今天的日期确定当前年份和月份，使用对应的文件
   - **月份格式**：使用两位数格式（01-12），例如 11 月为 `11`，1 月为 `01`
   - **示例**：如果今天是 2025-11-26，文件路径为 `daily-reports/[员工姓名]-2025-11.md`
   - 如果文件不存在，创建新文件
2. **生成日报内容**：
   - **日期**：今天的日期（格式：`YYYY-MM-DD`）
   - **工作回顾**：
     - 按工作类型列出今天完成的工作（功能开发、测试、文档、配置等）
     - 列出 Git 提交数量
     - 列出文件变更情况（新增、修改、删除的文件）
     - 列出完成的任务数量
     - 列出关键成果和进展（从提交信息和文件变更中提取）
   - **Git 提交详情**（可选，如果提交较多可以汇总）：
     - 列出主要提交的提交信息
     - 列出关键文件变更
   - **统计数据**：
     - 当前开发阶段和进度
     - 完成的任务数量
     - 测试覆盖率变化（如有）
     - 代码质量检查结果（RuboCop、测试通过情况等）
   - **工作总结**：
     - 今天的主要工作内容（基于 Git 提交和文件变更）
     - 遇到的问题和解决方案（如有，从提交信息或阶段笔记中提取）
     - 明天的计划（从 CURRENT_WORK.md 中提取，或根据当前进度推断）
3. **附加到日报文件**：
   - 在日报文件末尾追加今天的日报内容
   - 使用分隔线区分不同日期的日报
   - 保持文件格式整洁

### 步骤4：验证数据一致性

确保数据一致性：

- [ ] **缺失日报已检查**（首次对话时）：已检查从上次日报日期到昨天之间的所有日期，如有缺失已提醒或补写
- [ ] **项目进度文件已检查**：已读取 `CURRENT_WORK.md` 和各阶段的 `progress.md`
- [ ] **测试覆盖率已检查**：已读取覆盖率数据（如有）
- [ ] **Git 提交历史已分析**：已分析当天的所有提交
- [ ] **日报已生成**：已生成并附加到日报文件
- [ ] **文件格式正确**：日报文件格式符合规范

## ⚠️ 重要规则

1. **必须检查缺失的日报**：在首次对话时，必须先检查从上次日报日期到昨天之间的所有日期是否都有日报（步骤0）
2. **数据必须准确**：从项目进度文件和 Git 提交历史中提取真实数据，不要猜测
3. **时间格式统一**：使用格式 `YYYY-MM-DDTHH:mm:ss+0800`（如：`2025-11-26T19:56:17+0800`）
4. **按顺序执行**：先检查缺失的日报（首次对话时），再获取操作者信息，再回顾工作内容，然后生成日报，最后验证
5. **必须生成日报**：无论今天是否有工作完成，都要生成日报（如果今天没有工作，可以记录为"无工作内容"）
6. **日报格式统一**：使用统一的日报格式，保持文件整洁
7. **优先使用 Git 提交历史**：追踪员工工作内容时，优先使用 Git 提交历史，这是最准确的方法
8. **匹配员工身份**：如果 Git 配置中的姓名与提交历史中的作者不一致，优先使用提交历史中的作者信息
9. **分析文件变更**：不仅要看提交信息，还要分析文件变更，了解实际工作内容
10. **关注测试覆盖率**：如果项目有测试覆盖率要求，在日报中记录覆盖率变化
11. **关注代码质量**：在日报中记录代码质量检查结果（RuboCop、测试通过情况等）
12. **明确提醒缺失日报**：如果有缺失的日报，必须明确提醒员工，列出所有缺失的日期，不能忽略
13. **尊重员工选择**：如果员工选择稍后补写，应该尊重其选择，但要在下次首次对话时再次提醒

## 📝 数据提取规则

### 项目进度信息

从 `CURRENT_WORK.md` 提取：
- **当前阶段**：当前正在进行的开发阶段
- **当前任务**：当前正在进行的任务
- **已完成工作**：今天完成的工作列表
- **下一步计划**：明天的计划或下一步工作

### 阶段进度信息

从各阶段的 `progress.md` 提取（如 `docs/phase-1-authentication/progress.md`、`docs/phase-2-authorization/progress.md` 等）：
- **阶段状态**：阶段完成状态（进行中、已完成等）
- **完成进度**：阶段完成百分比
- **已完成任务**：今天完成的任务列表
- **总体进度**：阶段总体进度信息

### 测试覆盖率信息

从 `coverage/.resultset.json` 和 `coverage/.last_run.json` 提取：
- **整体覆盖率**：项目的整体测试覆盖率
- **覆盖率变化**：与之前相比的覆盖率变化（如有记录）
- **新增测试**：今天新增的测试用例数量
- **测试结果**：测试通过情况（测试数量、断言数量、失败数量等）

### Git 提交信息

从 Git 提交历史提取：
- **提交数量**：当天的提交总数
- **提交详情**：每个提交的哈希、作者、时间、提交信息
- **文件变更**：新增、修改、删除的文件列表
- **工作类型**：根据文件路径判断工作类型（功能开发、测试、文档、配置等）

## 💡 使用示例

### 首次对话时（有缺失的日报）

```
/daily-report（首次对话）
→ 检查缺失的日报（步骤0）
  → 检测到从 2025-11-23 到 2025-11-26 之间有 4 天的日报缺失
  → 询问是否现在补写
  → 用户确认补写
  → 按日期顺序依次补写所有缺失的日报
→ 获取操作者信息（步骤1）
→ 回顾今天工作（步骤2）
→ 生成员工日报（步骤3）
→ 验证一致性（步骤4）
```

### 首次对话时（没有缺失的日报）

```
/daily-report（首次对话）
→ 检查缺失的日报（步骤0）
  → ✓ 从上次日报到昨天之间的所有日期都有日报
→ 获取操作者信息（步骤1）
→ 回顾今天工作（步骤2）
→ 生成员工日报（步骤3）
→ 验证一致性（步骤4）
```

### 非首次对话时

```
/daily-report（非首次对话）
→ 跳过检查缺失的日报（步骤0，仅在首次对话时执行）
→ 获取操作者信息（步骤1）
→ 回顾今天工作（步骤2）
→ 生成员工日报（步骤3）
→ 验证一致性（步骤4）
```

### 其他使用方式

```
记录进度，更新统计，结束今天的工作
→ 执行完整流程（包括检查缺失的日报，如果是首次对话）

生成日报
→ 执行完整流程（包括检查缺失的日报，如果是首次对话）
```

**注意**：检查缺失日报的详细示例请参考规则文件 `.cursor/rules/check-missing-daily-report.mdc` 中的使用示例部分。

## 🔧 技术细节

### 时间获取

使用系统命令获取当前时间：
- **macOS/Linux**：`date "+%Y-%m-%dT%H:%M:%S%z"` 或 `date "+%Y-%m-%dT%H:%M:%S+0800"`
- **Windows**：`powershell -Command "Get-Date -Format 'yyyy-MM-ddTHH:mm:ss+0800'"`

获取今天日期（用于 Git 查询）：
- **macOS/Linux**：`date +%Y-%m-%d`
- **Windows**：`powershell -Command "Get-Date -Format 'yyyy-MM-dd'"`

获取昨天日期（用于检查昨天的日报）：
- **macOS/Linux**：`date -v-1d +%Y-%m-%d` 或 `date -d "yesterday" +%Y-%m-%d`（GNU date）
- **Windows**：`powershell -Command "(Get-Date).AddDays(-1).ToString('yyyy-MM-dd')"`

**注意**：macOS 的 date 命令使用 `-v-1d` 选项，Linux 的 GNU date 使用 `-d "yesterday"` 选项。

### Git 命令参考

#### 获取当天所有提交

```bash
# 基本格式
git log --author="[员工姓名或邮箱]" --since="[今天] 00:00:00" --until="[今天] 23:59:59" --pretty=format:"%H|%an|%ae|%ad|%s" --date=iso

# 示例（2025-11-26）
git log --author="xiaohui" --since="2025-11-26 00:00:00" --until="2025-11-26 23:59:59" --pretty=format:"%H|%an|%ae|%ad|%s" --date=iso

# 如果姓名匹配不准确，可以使用邮箱或部分匹配
git log --author="user@example.com" --since="2025-11-26 00:00:00" --until="2025-11-26 23:59:59"

# 或者使用 --all 搜索所有分支
git log --all --author="xiaohui" --since="2025-11-26 00:00:00" --until="2025-11-26 23:59:59"
```

#### 查看提交的文件变更

```bash
# 查看提交的文件变更统计
git show --stat [提交哈希]

# 查看提交的详细变更
git diff --stat [提交哈希]^..[提交哈希]

# 查看提交的文件列表
git show --name-only --pretty=format:"" [提交哈希]
```

#### 获取当天修改的所有文件

```bash
# 获取当天修改的所有文件（去重）
git log --since="[今天] 00:00:00" --until="[今天] 23:59:59" --name-only --pretty=format:"" --author="[员工姓名]" | sort -u

# 示例
git log --since="2025-11-26 00:00:00" --until="2025-11-26 23:59:59" --name-only --pretty=format:"" --author="xiaohui" | sort -u
```

#### 验证员工身份

```bash
# 查看最近一次提交的作者
git log -1 --pretty=format:"%an|%ae"

# 查看当天所有提交的作者（去重）
git log --since="[今天] 00:00:00" --until="[今天] 23:59:59" --pretty=format:"%an|%ae" | sort -u
```

### 数据格式

- **Markdown 格式**：日报文件使用 Markdown 格式
- **时间格式**：统一使用 `YYYY-MM-DDTHH:mm:ss+0800` 格式
- **Git 时间格式**：Git 查询使用 ISO 格式（`YYYY-MM-DD HH:MM:SS`）
- **JSON 格式**：测试覆盖率数据使用 JSON 格式（`coverage/.resultset.json`、`coverage/.last_run.json`）

### 文件路径

- **项目进度文件**：`CURRENT_WORK.md`（工作区根目录）
- **阶段进度文件**：`docs/phase-{阶段名}/progress.md`（如 `docs/phase-1-authentication/progress.md`）
- **阶段笔记文件**：`docs/phase-{阶段名}/notes.md`（如 `docs/phase-1-authentication/notes.md`）
- **测试覆盖率文件**：`coverage/.resultset.json`、`coverage/.last_run.json`（工作区根目录）
- **日报文件**：`daily-reports/[员工姓名]-[年份]-[月份].md`（工作区根目录，按年月归档）

### 日报格式

日报内容使用以下格式：

```markdown
---

## 📅 2025-11-26

### 📋 工作回顾

#### 功能开发
- 实现功能：[功能名称]
- 完成文件：`app/controllers/xxx_controller.rb`、`app/views/xxx/xxx.html.erb`
- 关键成果：...

#### 测试
- 新增测试用例：X 个
- 测试文件：`test/controllers/xxx_controller_test.rb`
- 关键成果：...

#### 文档
- 更新文档：[文档名称]
- 文档文件：`docs/xxx.md`
- 关键成果：...

### 📊 统计数据

- **当前阶段**：第二阶段 - 权限系统 + 管理后台
- **阶段进度**：98%
- **测试覆盖率**：28.33%（目标 85%）
- **测试结果**：494 个测试，1224 个断言，0 失败，0 错误，2 跳过
- **代码质量**：RuboCop 通过（112 个文件检查，0 错误）

### 💡 工作总结

今天主要完成了...
遇到的问题：...
解决方案：...

### 📝 明日计划

- 计划任务 1
- 计划任务 2
```

**注意**：
- 如果今天没有工作内容，在"工作回顾"部分记录为"今日无工作内容"
- 保持格式统一，使用分隔线区分不同日期的日报
- 日报内容要简洁明了，重点突出
- 根据实际工作内容调整工作类型分类（功能开发、测试、文档、配置、Bug 修复等）

---

**创建日期**：2025-11-26  
**最后更新**：2025-11-26  
**指令类型**：通用指令  
**适用项目**：BuildX.work (project-name)  
**相关规则**：`.cursor/rules/check-missing-daily-report.mdc`

