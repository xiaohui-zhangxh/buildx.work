---
description: Rails 测试开发规则和最佳实践。开发测试用例、运行测试、查看覆盖率时参考此规则。说明测试执行方式、并行测试配置、覆盖率统计等。
alwaysApply: false
---

# Rails 测试开发规则

## 概述

本规则说明 Rails 测试的执行方式、配置和最佳实践。包括并行测试配置、覆盖率统计、测试执行策略等。

**官方文档**：
- Rails 测试指南：https://guides.rubyonrails.org/testing.html
- SimpleCov 文档：https://github.com/simplecov-ruby/simplecov

## 核心原则

1. **默认并行**：默认启用并行测试（快速），适合日常开发
2. **准确统计**：查看覆盖率时必须使用单线程（`PARALLEL_WORKERS=1`）
3. **灵活选择**：根据需求选择并行或单线程测试
4. **及时更新**：完善测试用例后及时更新覆盖率任务清单

## 测试执行方式

### 1. 并行测试（默认，快速）

**适用场景**：
- 日常开发和快速验证
- 只检查测试是否通过
- CI/CD 环境（如果不需要覆盖率）

**执行方式**：

```bash
# 运行所有测试（默认并行，快速）
bin/rails test

# 运行特定测试文件
bin/rails test test/models/user_test.rb

# 运行特定测试用例
bin/rails test test/models/user_test.rb:10

# 指定 worker 数量
PARALLEL_WORKERS=2 bin/rails test  # 使用 2 个 worker
```

**特点**：
- ✅ 执行速度快（多线程并行）
- ✅ 适合快速验证测试结果
- ❌ 不统计覆盖率（SimpleCov 在并行测试时统计不准确）

### 2. 单线程测试（统计准确覆盖率）

**适用场景**：
- 需要查看测试覆盖率
- 需要准确的覆盖率数据
- 调试测试问题

**执行方式**（学习 Fizzy 的方式）：

```bash
# 单线程测试（统计准确覆盖率）
PARALLEL_WORKERS=1 bin/rails test

# 运行特定测试文件
PARALLEL_WORKERS=1 bin/rails test test/models/user_test.rb

# 运行特定测试用例
PARALLEL_WORKERS=1 bin/rails test test/models/user_test.rb:10
```

**特点**：
- ✅ 统计准确的覆盖率数据
- ✅ SimpleCov 可以正确跟踪代码覆盖率
- ❌ 执行速度较慢（单线程）

## 并行测试配置

### 配置位置

测试配置在 `test/test_helper.rb` 中：

```ruby
module ActiveSupport
  class TestCase
    # 默认启用并行测试（快速），需要准确覆盖率时使用 PARALLEL_WORKERS=1（单线程）
    if ENV["PARALLEL_WORKERS"]
      workers = ENV["PARALLEL_WORKERS"].to_i
      # PARALLEL_WORKERS=1 时不启用并行测试（单线程，用于覆盖率统计）
      parallelize(workers: workers) if workers > 1
    else
      # 默认启用并行测试（使用所有可用处理器）
      parallelize(workers: :number_of_processors)
    end
  end
end
```

### 配置说明

- **环境变量**：`PARALLEL_WORKERS`（学习 Fizzy 的方式）
- **默认行为**：默认启用并行测试（使用所有可用处理器，快速）
- **单线程模式**：`PARALLEL_WORKERS=1` 时使用单线程测试（统计准确覆盖率）
- **指定 worker 数量**：`PARALLEL_WORKERS=N` 时使用 N 个 worker 并行测试

### 为什么并行测试时覆盖率不准确？

**原因**：
- SimpleCov 在并行测试时需要合并多个进程的覆盖率数据
- 合并过程可能有问题，导致覆盖率数据不准确
- 参考：https://github.com/simplecov-ruby/simplecov/issues/1111

**影响**：
- 并行测试时，覆盖率数据可能显示为 0% 或明显偏低
- 单独运行测试时覆盖率正常，但运行所有测试时覆盖率异常

**解决方案**：
- 查看覆盖率时，必须使用单线程测试：`PARALLEL_WORKERS=1 bin/rails test`
- 只检查测试结果时，可以使用默认并行测试（快速）

## 测试覆盖率

### 覆盖率要求

- **目标覆盖率**：85%（整体项目覆盖率）
- **配置位置**：`test/supports/simplecov.rb`
- **覆盖率数据文件**：
  - `coverage/.last_run.json`：整体覆盖率信息
  - `coverage/.resultset.json`：详细覆盖率数据

### 查看覆盖率

**用户查看覆盖率报告**：

```bash
# 运行测试生成覆盖率报告（单线程）
PARALLEL_WORKERS=1 bin/rails test

# 在浏览器中打开 HTML 报告
open coverage/index.html
```

**AI 分析覆盖率数据**（必须读取 JSON 文件）：

```bash
# 读取整体覆盖率信息
read_file("coverage/.last_run.json")

# 读取详细覆盖率数据
read_file("coverage/.resultset.json")
```

**注意**：AI 无法读取浏览器内容，必须读取 JSON 数据文件。

### 检查特定文件覆盖率

**使用环境变量 `COVERAGE_FILES`**：

```bash
# 检查单个文件
COVERAGE_FILES=app/models/user.rb bin/rails test test/models/user_test.rb

# 检查多个文件
COVERAGE_FILES=app/models/user.rb,app/controllers/sessions_controller.rb bin/rails test

# 检查目录
COVERAGE_FILES=app/models bin/rails test test/models/
```

### 覆盖率统计规则

**重要规则**：
1. **必须使用单线程**：查看覆盖率时，必须使用单线程测试：`PARALLEL_WORKERS=1 bin/rails test`
2. **不要过度追求 100%**：85% 是整体项目的覆盖率要求，不是每个文件都必须达到 100%
3. **关注核心功能**：优先完善核心业务逻辑的测试，而不是追求每个文件的完美覆盖率

## 测试执行策略

### 日常开发

**快速验证代码修改**：

```bash
# 使用默认并行测试快速验证（默认）
bin/rails test

# 或运行特定测试文件
bin/rails test test/models/user_test.rb
```

**完善测试用例后**：

```bash
# 使用单线程测试查看覆盖率
PARALLEL_WORKERS=1 bin/rails test

# 查看覆盖率报告
open coverage/index.html
```

### CI/CD 环境

**如果不需要覆盖率**：

```bash
# 使用默认并行测试加快 CI 速度（默认）
bin/rails test
```

**如果需要覆盖率**：

```bash
# 使用单线程测试统计覆盖率
PARALLEL_WORKERS=1 bin/rails test

# 上传覆盖率报告到 CI 系统
```

### 调试测试问题

**使用单线程测试**：

```bash
# 单线程测试更容易调试
bin/rails test test/models/user_test.rb

# 查看详细输出
bin/rails test test/models/user_test.rb --verbose
```

## 测试文件组织

### 测试文件位置

- **模型测试**：`test/models/`
- **控制器测试**：`test/controllers/`
- **集成测试**：`test/integration/`
- **系统测试**：`test/system/`
- **辅助测试**：`test/helpers/`
- **邮件测试**：`test/mailers/`
- **任务测试**：`test/jobs/`
- **策略测试**：`test/policies/`

### 测试文件命名

- **模型测试**：`test/models/user_test.rb` → `app/models/user.rb`
- **控制器测试**：`test/controllers/sessions_controller_test.rb` → `app/controllers/sessions_controller.rb`
- **集成测试**：`test/integration/user_flows_test.rb`

## 测试最佳实践

### 1. 测试命名

**使用描述性名称**：

```ruby
# ✅ 好的命名
test "should create user with valid attributes" do
  # ...
end

test "should not create user with invalid email" do
  # ...
end

# ❌ 不好的命名
test "test user creation" do
  # ...
end
```

### 2. 测试组织

**使用 setup 和 teardown**：

```ruby
class UserTest < ActiveSupport::TestCase
  setup do
    @user = users(:one)
  end

  teardown do
    # 清理资源
  end

  test "should be valid" do
    assert @user.valid?
  end
end
```

### 3. 测试覆盖

**覆盖主要功能路径**：
- 正常流程
- 错误处理
- 边界情况
- 验证规则

### 4. 测试独立性

**每个测试应该独立**：
- 不依赖其他测试的执行顺序
- 不依赖全局状态
- 使用 fixtures 或 factories 创建测试数据

## 常见问题

### 1. 覆盖率数据不准确

**问题**：运行所有测试时覆盖率显示为 0%，但单独运行测试时覆盖率正常。

**原因**：使用了并行测试（默认），SimpleCov 在并行测试时统计不准确。

**解决方案**：
- 查看覆盖率时，使用单线程测试：`PARALLEL_WORKERS=1 bin/rails test`
- 只检查测试结果时，可以使用默认并行测试（快速）

### 2. 测试执行速度慢

**问题**：单线程测试执行速度慢。

**解决方案**：
- 只检查测试结果时，使用默认并行测试（快速）：`bin/rails test`（默认）
- 查看覆盖率时，使用单线程测试（必须）：`PARALLEL_WORKERS=1 bin/rails test`

### 3. 并行测试失败

**问题**：并行测试时某些测试失败，但单线程测试时通过。

**原因**：测试之间存在依赖关系或共享状态。

**解决方案**：
- 检查测试是否独立
- 检查是否有共享的全局状态
- 使用 `setup` 和 `teardown` 清理状态

## 相关文件索引

- **测试配置**：`test/test_helper.rb`
- **覆盖率配置**：`test/supports/simplecov.rb`
- **覆盖率任务清单**：`TEST_COVERAGE_TASKS.md`
- **测试覆盖率规则**：`.cursor/rules/test-coverage-tracking.mdc`
- **开发者指南**：`docs/DEVELOPER_GUIDE.md`（测试规范章节）

## 注意事项

1. **默认并行测试**：默认启用并行测试（快速），适合日常开发和快速验证
2. **必须使用单线程查看覆盖率**：查看覆盖率时，必须使用单线程测试：`PARALLEL_WORKERS=1 bin/rails test`
3. **并行测试不统计覆盖率**：并行测试时，SimpleCov 覆盖率统计不准确，不要依赖并行测试的覆盖率数据
4. **灵活选择执行方式**：根据需求选择并行或单线程测试
5. **及时更新覆盖率任务清单**：完善测试用例后，及时更新 `TEST_COVERAGE_TASKS.md`
