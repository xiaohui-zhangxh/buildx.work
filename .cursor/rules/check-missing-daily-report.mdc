---
description: 检查员工是否忘记写日报。检查从上次日报日期到昨天之间的所有缺失日期，如果缺失则提醒补写。仅在首次对话时应用此规则。
alwaysApply: false
---

# 检查忘写日报规则

## 📋 规则说明

**重要**：此规则仅在首次对话时应用。在首次对话时，如果涉及生成今天的日报或开始工作，应该先检查从上次日报日期到昨天之间的所有日期是否都有日报。如果员工几天没来工作，可能会有多天的日报缺失，需要提醒补写所有缺失的日报，确保日报的连续性。

**应用时机**：仅在首次对话时执行此检查，后续对话中不再重复检查。

**检查范围**：从员工日报文件中最后一个日期到昨天之间的所有日期（不包括今天）。

## 🎯 适用场景

- **首次对话时生成日报**：在首次对话中生成今天的日报之前，先检查昨天的日报
- **首次对话时开始工作**：在首次对话中开始新的一天工作之前，检查昨天的日报是否完成
- **首次对话时**：在第一次对话时，检查昨天的日报状态

**注意**：此规则不适用于非首次对话的场景。

## 🔍 检查流程

### 步骤1：获取员工身份

1. **获取 Git 用户信息**：
   - 使用 `git config user.name` 获取用户名
   - 使用 `git config user.email` 获取用户邮箱
   - 如果 Git 配置为空，提示用户输入员工姓名

2. **确定员工日报文件路径**：
   - **文件命名规则**：按年月归档，格式为 `daily-reports/[员工姓名]-[年份]-[月份].md`
   - **示例**：`daily-reports/xiaohui-2025-11.md`、`daily-reports/张三-2025-12.md`
   - **原因**：避免单个文件过大，便于查找和管理，每月一个文件更易于维护
   - 如果员工姓名包含空格或特殊字符，使用安全的文件名格式
   - **当前月份文件**：根据今天的日期确定当前年份和月份，使用对应的文件
   - **月份格式**：使用两位数格式（01-12），例如 11 月为 `11`，1 月为 `01`

### 步骤2：获取昨天日期

1. **获取当前日期**：
   - 使用系统命令获取当前日期（格式：`YYYY-MM-DD`）
   - **macOS/Linux**：`date +%Y-%m-%d`
   - **Windows**：`powershell -Command "Get-Date -Format 'yyyy-MM-dd'"`

2. **计算昨天日期**：
   - **macOS**：`date -v-1d +%Y-%m-%d`
   - **Linux（GNU date）**：`date -d "yesterday" +%Y-%m-%d`
   - **Windows**：`powershell -Command "(Get-Date).AddDays(-1).ToString('yyyy-MM-dd')"`

### 步骤3：检查缺失的日报日期

1. **确定需要检查的年月范围**：
   - 获取今天的年份、月份和昨天的年份、月份
   - 如果跨月份或跨年份，需要检查多个年月组合的文件
   - 生成需要检查的年月列表（格式：`YYYY-MM`）

2. **查找所有相关的日报文件**：
   - 根据年月列表，查找对应的日报文件：`daily-reports/[员工姓名]-[年份]-[月份].md`
   - 例如：如果检查 2025-11-23 到 2025-12-31，需要查找：
     - `daily-reports/[员工姓名]-2025-11.md`
     - `daily-reports/[员工姓名]-2025-12.md`
   - 如果跨年份，需要查找更多文件

3. **查找日报文件中的最后一个日期**：
   - **如果文件存在**：
     - 读取所有相关年月的日报文件
     - 解析文件内容，查找所有日期标题（格式：`## 📅 YYYY-MM-DD`）
     - 提取所有日期，找到最后一个日期（最新的日期）
   - **如果文件不存在**：
     - 说明从有记录开始到昨天之间的所有日期都没有日报
   - **如果文件中没有任何日期**：
     - 说明从有记录开始到昨天之间的所有日期都没有日报

4. **计算需要检查的日期范围**：
   - **起始日期**：日报文件中最后一个日期 + 1 天（如果文件不存在或没有日期，从最早可能的日期开始，或询问员工）
   - **结束日期**：昨天（不包括今天）
   - **计算所有日期**：生成从起始日期到结束日期之间的所有日期列表（可能跨月份、跨年份）

5. **检查每个日期是否有日报**：
   - 对于日期范围内的每个日期：
     - 确定该日期所属的年份和月份（格式：`YYYY-MM`）
     - 读取对应年月的日报文件：`daily-reports/[员工姓名]-[年份]-[月份].md`
     - 检查文件中是否包含该日期的标题（格式：`## 📅 YYYY-MM-DD`）
     - 例如：检查 2025-11-24，在 `daily-reports/[员工姓名]-2025-11.md` 中查找 `## 📅 2025-11-24`

6. **汇总缺失的日期**：
   - 列出所有缺失日报的日期
   - 按日期顺序排列（从早到晚）
   - 按年月分组（便于查看）
   - 统计缺失的天数

### 步骤4：提醒补写日报

#### 如果有缺失的日报

1. **明确提醒员工**：
   - 使用清晰的提示信息：
     - 如果只有一天缺失："⚠️ 检测到 [缺失日期] 没有生成日报，请先补写该日的日报"
     - 如果有多天缺失："⚠️ 检测到从 [起始日期] 到 [结束日期] 之间有 [缺失天数] 天的日报缺失，请先补写这些日期的日报"
   - 列出所有缺失的日期（按日期顺序）
   - 说明补写日报的重要性（保持日报连续性、记录工作内容等）

2. **询问是否现在补写**：
   - 询问员工："是否现在补写缺失的日报？"
   - 提供选项：现在补写 / 稍后补写
   - 如果有多天缺失，可以询问："是否按日期顺序依次补写所有缺失的日报？"

3. **如果员工确认补写**：
   - **如果只有一天缺失**：
     - 执行补写日报流程（见下方）
   - **如果有多天缺失**：
     - 按日期顺序（从早到晚）依次补写每一天的日报
     - 对于每一天，执行补写日报流程：
       1. 获取该缺失日期
       2. 确定日报文件路径
       3. 分析该日期的 Git 提交历史（使用 `git log --author="[员工姓名]" --since="[日期] 00:00:00" --until="[日期] 23:59:59"`）
       4. 分析该日期的文件变更
       5. 结合该日期的项目进度文件（CURRENT_WORK.md、各阶段的 progress.md 和 notes.md）
       6. 检查该日期的测试覆盖率（如有）
       7. 生成该日期的日报并附加到日报文件中
     - 每补写完一天，继续补写下一天
     - 所有缺失的日报补写完成后，继续执行今天的工作流程

4. **如果员工选择稍后补写**：
   - 记录提醒状态和缺失的日期列表（可选）
   - 继续执行今天的工作流程
   - 在下次使用相关指令时再次提醒

#### 补写日报流程（单日）

对于每个缺失的日期，执行以下流程：

1. **获取缺失日期**：确定要补写的日期（格式：`YYYY-MM-DD`）

2. **确定日报文件路径**：
   - 根据日期确定年份和月份（格式：`YYYY-MM`）
   - 日报文件路径：`daily-reports/[员工姓名]-[年份]-[月份].md`
   - 例如：2025-11-24 → `daily-reports/[员工姓名]-2025-11.md`
   - 月份格式：使用两位数格式（01-12），例如 11 月为 `11`，1 月为 `01`
   - 如果文件不存在，创建新文件

3. **分析该日期的 Git 提交历史**：
   - 使用 `git log --author="[员工姓名]" --since="[日期] 00:00:00" --until="[日期] 23:59:59" --pretty=format:"%H|%an|%ae|%ad|%s" --date=iso` 获取该日期的所有提交
   - 分析每个提交的文件变更
   - 按工作类型分类提交（功能开发、测试、文档、配置等）

4. **分析该日期的文件变更**：
   - 使用 `git log --since="[日期] 00:00:00" --until="[日期] 23:59:59" --name-only --pretty=format:"" --author="[员工姓名]" | sort -u` 获取该日期修改的所有文件
   - 分析文件类型和工作内容（控制器、模型、视图、测试、文档、配置等）

5. **结合该日期的项目进度文件**：
   - 读取 `CURRENT_WORK.md`，提取该日期完成的任务和进展
   - 检查各阶段的 `progress.md`（如 `docs/phase-1-authentication/progress.md`、`docs/phase-2-authorization/progress.md` 等），查找该日期完成的任务
   - 检查各阶段的 `notes.md`，提取该日期记录的技术决策和问题解决方案

6. **检查该日期的测试覆盖率**（如有）：
   - 如果该日期有测试覆盖率数据，读取并记录覆盖率变化
   - 记录新增的测试用例数量

7. **生成该日期的日报**：
   - 生成日报内容（格式与生成今天日报相同）
   - 按工作类型分类（功能开发、测试、文档、配置等）
   - 包含统计数据（当前阶段、进度、测试覆盖率等）
   - 附加到对应年月的日报文件中（按日期顺序插入，保持文件格式整洁）
   - 如果跨月份或跨年份补写，确保写入正确的年月文件

#### 如果没有缺失的日报

- 继续执行今天的工作流程
- 无需额外提醒

## ⚠️ 重要规则

1. **仅在首次对话时应用**：此规则仅在首次对话时执行检查，后续对话中不再重复检查
2. **必须检查所有缺失日期**：在首次对话中生成今天的日报之前，必须检查从上次日报日期到昨天之间的所有日期
3. **明确提醒**：如果有缺失的日报，必须明确提醒员工，列出所有缺失的日期，不能忽略
4. **按日期顺序补写**：如果有多天缺失，必须按日期顺序（从早到晚）依次补写
5. **尊重选择**：如果员工选择稍后补写，应该尊重其选择，但要在下次首次对话时再次提醒
6. **补写流程**：补写缺失日期的日报时，使用与生成今天日报相同的流程，只是日期不同
7. **检查时机**：这个检查应该在首次对话时执行（即生成今天的日报之前）
8. **不再重复检查**：一旦在首次对话中完成检查（无论是否补写），后续对话中不再重复执行此检查
9. **处理文件不存在的情况**：如果日报文件不存在，需要询问员工从哪个日期开始补写，或使用合理的默认值（如最近一周）

## 🔧 技术细节

### 获取昨天日期的命令

- **macOS**：`date -v-1d +%Y-%m-%d`
- **Linux（GNU date）**：`date -d "yesterday" +%Y-%m-%d`
- **Windows**：`powershell -Command "(Get-Date).AddDays(-1).ToString('yyyy-MM-dd')"`

### 解析日报文件中的日期

日报文件中的日期标题格式：
```markdown
## 📅 YYYY-MM-DD
```

**解析方法**（支持多年月文件）：
1. 确定需要检查的年月范围
2. 读取所有相关年月的日报文件内容
3. 使用正则表达式匹配所有日期标题：`^## 📅 (\d{4}-\d{2}-\d{2})`
4. 提取所有日期，转换为日期对象
5. 找到最后一个日期（最新的日期）

**示例**：
```python
import re
import glob
from datetime import datetime

# 查找所有年月的日报文件
employee_name = "xiaohui"
file_pattern = f"daily-reports/{employee_name}-*.md"
files = glob.glob(file_pattern)
# 结果可能是：['daily-reports/xiaohui-2025-11.md', 'daily-reports/xiaohui-2025-12.md', 'daily-reports/xiaohui-2026-01.md']

# 读取所有文件并提取日期
all_dates = []
for file_path in files:
    content = read_file(file_path)
    # 匹配所有日期标题
    pattern = r'^## 📅 (\d{4}-\d{2}-\d{2})'
    dates = re.findall(pattern, content, re.MULTILINE)
    all_dates.extend(dates)

# 转换为日期对象并排序
date_objects = [datetime.strptime(d, '%Y-%m-%d') for d in all_dates]
last_date = max(date_objects) if date_objects else None
```

### 计算日期范围

**生成日期列表**：
- 从起始日期到结束日期（不包括今天）
- 按日期顺序排列（从早到晚）

**示例**：
```python
from datetime import datetime, timedelta

start_date = datetime(2025, 11, 23)
end_date = datetime(2025, 11, 26)  # 昨天

current = start_date
date_list = []
while current <= end_date:
    date_list.append(current.strftime('%Y-%m-%d'))
    current += timedelta(days=1)
# 结果：['2025-11-23', '2025-11-24', '2025-11-25', '2025-11-26']
```

### 检查日报格式

检查时应该查找精确匹配的日期格式：
- 日期标题格式：`## 📅 YYYY-MM-DD`
- 使用正则表达式或字符串匹配

### 查找日报文件

**查找所有年月的日报文件**：
```bash
# 查找某个员工的所有年月日报文件
ls daily-reports/[员工姓名]-*.md

# 示例：查找 xiaohui 的所有年月日报
ls daily-reports/xiaohui-*.md
# 结果可能是：xiaohui-2025-11.md, xiaohui-2025-12.md, xiaohui-2026-01.md
```

**确定需要检查的年月**：
- 从起始日期到结束日期，提取所有涉及的年月组合（格式：`YYYY-MM`）
- 例如：从 2025-11-28 到 2025-12-02，涉及 2025-11 和 2025-12 两个年月
- 需要检查两个文件：`daily-reports/[员工姓名]-2025-11.md` 和 `daily-reports/[员工姓名]-2025-12.md`
- 如果跨年份：从 2025-12-30 到 2026-01-02，涉及 2025-12 和 2026-01 两个年月

**根据日期确定文件路径**：
```python
from datetime import datetime

date_str = "2025-11-26"
date_obj = datetime.strptime(date_str, "%Y-%m-%d")
year = date_obj.year
month = date_obj.month
# 月份格式化为两位数
month_str = f"{month:02d}"  # 11 月为 "11", 1 月为 "01"
file_path = f"daily-reports/[员工姓名]-{year}-{month_str}.md"
# 结果：daily-reports/[员工姓名]-2025-11.md
```

### Git 提交历史查询

补写缺失日期的日报时，使用以下命令查询该日期的 Git 提交：
```bash
# 查询指定日期的提交
git log --author="[员工姓名]" --since="[日期] 00:00:00" --until="[日期] 23:59:59" --pretty=format:"%H|%an|%ae|%ad|%s" --date=iso

# 示例：查询 2025-11-25 的提交
git log --author="xiaohui" --since="2025-11-25 00:00:00" --until="2025-11-25 23:59:59" --pretty=format:"%H|%an|%ae|%ad|%s" --date=iso

# 查看提交的文件变更统计
git show --stat [提交哈希]

# 查看提交的文件列表
git show --name-only --pretty=format:"" [提交哈希]
```

### 项目进度文件查询

补写缺失日期的日报时，需要查询以下文件：
- **项目进度文件**：`CURRENT_WORK.md`（工作区根目录）
- **阶段进度文件**：`docs/phase-{阶段名}/progress.md`（如 `docs/phase-1-authentication/progress.md`）
- **阶段笔记文件**：`docs/phase-{阶段名}/notes.md`（如 `docs/phase-1-authentication/notes.md`）

### 测试覆盖率查询

如果该日期有测试覆盖率数据，可以查询：
- **覆盖率数据文件**：`coverage/.resultset.json`、`coverage/.last_run.json`（工作区根目录）
- **注意**：测试覆盖率数据是累积的，需要结合 Git 提交历史判断该日期新增的测试用例

## 💡 使用示例

### 场景1：没有缺失的日报

```
AI：检查缺失的日报...
AI：✓ 从上次日报（2025-11-25）到昨天（2025-11-26）之间的所有日期都有日报，继续生成今天的日报。
```

### 场景2：只有一天缺失

```
AI：检查缺失的日报...
AI：⚠️ 检测到 2025-11-25 没有生成日报，请先补写该日的日报。
AI：是否现在补写缺失的日报？
用户：是
AI：正在分析 2025-11-25 的 Git 提交历史...
AI：正在生成 2025-11-25 的日报...
AI：✓ 2025-11-25 的日报已补写完成。现在继续生成今天的日报。
```

### 场景3：多天缺失

```
AI：检查缺失的日报...
AI：⚠️ 检测到从 2025-11-23 到 2025-11-26 之间有 4 天的日报缺失：
   - 2025-11-23
   - 2025-11-24
   - 2025-11-25
   - 2025-11-26
   请先补写这些日期的日报。
AI：是否按日期顺序依次补写所有缺失的日报？
用户：是
AI：正在补写 2025-11-23 的日报...
AI：✓ 2025-11-23 的日报已补写完成。
AI：正在补写 2025-11-24 的日报...
AI：✓ 2025-11-24 的日报已补写完成。
AI：正在补写 2025-11-25 的日报...
AI：✓ 2025-11-25 的日报已补写完成。
AI：正在补写 2025-11-26 的日报...
AI：✓ 2025-11-26 的日报已补写完成。
AI：✓ 所有缺失的日报已补写完成。现在继续生成今天的日报。
```

### 场景4：员工选择稍后补写

```
AI：检查缺失的日报...
AI：⚠️ 检测到从 2025-11-23 到 2025-11-26 之间有 4 天的日报缺失，请先补写这些日期的日报。
AI：是否现在补写缺失的日报？
用户：稍后
AI：好的，稍后补写。现在继续生成今天的日报。
AI：（下次首次对话时再次提醒）
```

### 场景5：日报文件不存在

```
AI：检查缺失的日报...
AI：日报文件不存在，需要确定补写日报的起始日期。
AI：请告诉我从哪个日期开始补写日报？（例如：2025-11-20）
用户：2025-11-23
AI：将从 2025-11-23 到昨天（2025-11-26）之间的日期进行检查...
AI：⚠️ 检测到从 2025-11-23 到 2025-11-26 之间有 4 天的日报缺失...
AI：这些日报将归档到 daily-reports/[员工姓名]-2025-11.md 文件中。
```

### 场景6：跨月份补写

```
AI：检查缺失的日报...
AI：⚠️ 检测到从 2025-11-28 到 2025-12-02 之间有 5 天的日报缺失：
   - 2025-11-28（归档到 2025-11.md）
   - 2025-11-29（归档到 2025-11.md）
   - 2025-11-30（归档到 2025-11.md）
   - 2025-12-01（归档到 2025-12.md）
   - 2025-12-02（归档到 2025-12.md）
AI：是否按日期顺序依次补写所有缺失的日报？
用户：是
AI：正在补写 2025-11-28 的日报（归档到 2025-11.md）...
AI：正在补写 2025-12-01 的日报（归档到 2025-12.md）...
```

### 场景4：非首次对话（不执行检查）

```
用户：/daily-report（非首次对话）
AI：直接执行生成今天的日报流程，不再检查昨天的日报。
```

## 📝 相关文件

- **日报文件位置**：`daily-reports/[员工姓名]-[年份]-[月份].md`（按年月归档）
- **日报生成指令**：`.cursor/commands/daily-report.md`
- **项目进度文件**：`CURRENT_WORK.md`（工作区根目录）
- **阶段进度文件**：`docs/phase-{阶段名}/progress.md`（如 `docs/phase-1-authentication/progress.md`）
- **阶段笔记文件**：`docs/phase-{阶段名}/notes.md`（如 `docs/phase-1-authentication/notes.md`）
- **测试覆盖率文件**：`coverage/.resultset.json`、`coverage/.last_run.json`（工作区根目录）

## 📁 文件组织说明

### 按年月归档的原因

1. **避免文件过大**：如果项目执行几年，单个文件会变得非常庞大，难以管理
2. **便于查找**：知道年份和月份就能快速定位到对应的文件
3. **提高性能**：读取和写入单个月份的文件比读取整个文件更快
4. **便于维护**：可以按月份归档或备份，每月一个文件更易于管理
5. **便于回顾**：可以快速查看某个月的工作情况

### 文件命名规则

- **格式**：`[员工姓名]-[年份]-[月份].md`
- **月份格式**：使用两位数格式（01-12），例如 11 月为 `11`，1 月为 `01`
- **示例**：
  - `xiaohui-2025-11.md` - xiaohui 2025年11月的日报
  - `xiaohui-2025-12.md` - xiaohui 2025年12月的日报
  - `xiaohui-2026-01.md` - xiaohui 2026年1月的日报
  - `张三-2025-11.md` - 张三 2025年11月的日报

### 跨月份/跨年份处理

- 如果检查的日期范围跨月份或跨年份，需要读取多个年月组合的文件
- 补写日报时，确保写入正确的年月文件
- 查找最后一个日期时，需要检查所有相关的年月文件

---

**创建日期**：2025-11-26  
**最后更新**：2025-11-26  
**规则版本**：v1.1  
**适用项目**：BuildX.work (project-name)
