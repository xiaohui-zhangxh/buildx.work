---
description: Rails 调试开发规则和最佳实践。开发调试功能、排查问题、性能优化时参考此规则。说明 AI 如何帮助用户调试问题、分析错误、查找代码、理解日志等。
alwaysApply: false
---
# Rails 调试开发规则

## 概述

本规则说明 AI 如何帮助用户调试 Rails 应用问题。AI 应该使用工具（read_file、grep、codebase_search 等）来分析代码、日志、错误信息，识别问题并提供解决方案。

**官方文档**：https://guides.rubyonrails.org/debugging_rails_applications.html

## 核心原则

1. **主动分析**：遇到错误或问题时，主动使用工具分析相关代码、日志、配置
2. **系统性排查**：从错误堆栈、日志、代码、配置等多个角度排查问题
3. **提供解决方案**：不仅指出问题，还要提供具体的修复建议和代码修改
4. **理解上下文**：理解代码执行流程、数据流、依赖关系

## 调试流程

### 1. 理解问题

**获取信息**：
- 错误消息和堆栈跟踪
- 相关日志内容
- 用户描述的问题现象
- 复现步骤

**分析错误堆栈**：
- 识别错误类型（ActiveRecord::RecordNotFound、ActionPolicy::Unauthorized 等）
- 找到错误发生的文件和行号
- 理解调用链（从控制器到模型到数据库）

### 2. 查找相关代码

**使用工具查找代码**：

```ruby
# 使用 codebase_search 查找相关功能
codebase_search("How does user authentication work?")
codebase_search("Where is email confirmation handled?")

# 使用 grep 查找特定方法或类
grep("def authenticate", path: "app/controllers")
grep("User.find", path: "app")

# 使用 read_file 读取相关文件
read_file("app/controllers/sessions_controller.rb")
read_file("app/models/user.rb")
```

**查找相关文件**：
- 控制器：`app/controllers/`
- 模型：`app/models/`
- 视图：`app/views/`
- 配置：`config/`
- 路由：`config/routes.rb`
- 初始化器：`config/initializers/`

### 3. 分析日志

**读取日志文件**：

```bash
# 使用 read_file 读取日志
read_file("log/development.log", offset: -100)  # 最后 100 行
read_file("log/test.log")

# 使用 grep 搜索特定错误
grep("ERROR", path: "log/development.log")
grep("ActiveRecord::RecordNotFound", path: "log/")
```

**分析日志内容**：
- 查找错误消息和堆栈跟踪
- 识别 SQL 查询问题（N+1 查询、慢查询）
- 查看请求参数和响应状态
- 检查认证和授权日志

### 4. 检查配置

**检查配置文件**：

```ruby
# 环境配置
read_file("config/environments/development.rb")
read_file("config/environments/production.rb")

# 数据库配置
read_file("config/database.yml")

# 路由配置
read_file("config/routes.rb")

# 初始化器
read_file("config/initializers/")
```

**检查依赖**：
- Gemfile 和 Gemfile.lock
- package.json（前端依赖）
- 数据库迁移文件

### 5. 分析测试

**查看测试文件**：

```ruby
# 读取测试文件
read_file("test/controllers/sessions_controller_test.rb")
read_file("test/models/user_test.rb")

# 运行测试查看失败信息
run_terminal_cmd("bin/rails test test/models/user_test.rb")
```

**分析测试失败**：
- 理解测试期望和实际结果
- 检查测试数据和 fixtures
- 查看测试覆盖率报告

## 常见问题类型和排查方法

### 1. ActiveRecord 错误

**常见错误**：
- `ActiveRecord::RecordNotFound`：记录不存在
- `ActiveRecord::RecordInvalid`：验证失败
- `ActiveRecord::StatementInvalid`：SQL 错误

**排查步骤**：

1. **查看错误堆栈**：找到调用 `find`、`create`、`update` 的位置
2. **检查模型验证**：查看模型的 `validates` 规则
3. **检查数据库状态**：查看迁移文件和 schema
4. **查看相关代码**：

```ruby
# 查找相关模型
read_file("app/models/user.rb")
grep("validates", path: "app/models/user.rb")

# 查找调用位置
grep("User.find", path: "app/controllers")
grep("user.save", path: "app/")
```

### 2. 路由错误

**常见错误**：
- `ActionController::RoutingError`：路由不存在
- `No route matches`：路由不匹配

**排查步骤**：

1. **查看路由配置**：
```ruby
read_file("config/routes.rb")
```

2. **检查路由定义**：
- 确认路由路径和方法（GET、POST 等）
- 检查路由参数（:id、:format 等）
- 查看命名空间和资源路由

3. **使用 grep 查找路由使用**：
```ruby
grep("users_path", path: "app/views")
grep("redirect_to", path: "app/controllers")
```

### 3. 认证和授权错误

**常见错误**：
- `ActionPolicy::Unauthorized`：权限不足
- 未登录访问受保护资源
- 认证失败

**排查步骤**：

1. **查看认证相关代码**：
```ruby
codebase_search("How does authentication work?")
read_file("app/controllers/concerns/authentication.rb")
read_file("app/controllers/sessions_controller.rb")
```

2. **检查权限策略**：
```ruby
read_file("app/policies/user_policy.rb")
grep("authorize", path: "app/controllers")
```

3. **查看 before_action**：
```ruby
grep("require_authentication", path: "app/controllers")
grep("before_action", path: "app/controllers")
```

### 4. 视图和模板错误

**常见错误**：
- `ActionView::Template::Error`：模板错误
- `undefined method`：方法不存在
- `missing partial`：部分模板缺失

**排查步骤**：

1. **查看视图文件**：
```ruby
read_file("app/views/sessions/new.html.erb")
glob_file_search("**/sessions/*.erb")
```

2. **检查 helper 方法**：
```ruby
read_file("app/helpers/application_helper.rb")
grep("def current_user", path: "app/helpers")
```

3. **检查部分模板**：
```ruby
glob_file_search("**/_*.erb")
grep("render partial", path: "app/views")
```

### 5. 性能问题

**常见问题**：
- N+1 查询
- 慢查询
- 内存泄漏

**排查步骤**：

1. **分析日志中的 SQL 查询**：
```ruby
grep("SELECT", path: "log/development.log", -A: 5)
```

2. **查找可能的 N+1 查询**：
```ruby
# 查找循环中的数据库查询
codebase_search("Where are database queries executed in loops?")
grep(".each", path: "app/controllers")
grep(".map", path: "app/controllers")
```

3. **检查关联加载**：
```ruby
grep("includes", path: "app/controllers")
grep("eager_load", path: "app/controllers")
grep("preload", path: "app/controllers")
```

### 6. 配置问题

**常见问题**：
- 环境变量未设置
- 配置值错误
- 初始化器错误

**排查步骤**：

1. **检查环境配置**：
```ruby
read_file("config/environments/development.rb")
read_file("config/environments/production.rb")
```

2. **检查初始化器**：
```ruby
list_dir("config/initializers")
read_file("config/initializers/")
```

3. **查找环境变量使用**：
```ruby
grep("ENV\[", path: "config/")
grep("ENV.fetch", path: "app/")
```

## 使用工具的最佳实践

### 1. codebase_search（语义搜索）

**适用场景**：
- 理解功能实现逻辑
- 查找相关代码
- 了解代码架构

**示例**：

```ruby
# 理解认证流程
codebase_search("How does user sign in work?")

# 查找邮件发送逻辑
codebase_search("Where are emails sent to users?")

# 了解权限检查
codebase_search("How are permissions checked in controllers?")
```

### 2. grep（精确搜索）

**适用场景**：
- 查找特定方法调用
- 查找特定类或模块
- 查找配置项

**示例**：

```ruby
# 查找方法定义
grep("def authenticate", path: "app/")

# 查找方法调用
grep("User.find", path: "app/controllers")

# 查找配置
grep("config.cache_store", path: "config/")
```

### 3. read_file（读取文件）

**适用场景**：
- 查看完整文件内容
- 理解代码逻辑
- 检查配置

**示例**：

```ruby
# 读取完整文件
read_file("app/controllers/sessions_controller.rb")

# 读取部分文件（大文件）
read_file("app/models/user.rb", offset: 1, limit: 50)

# 读取日志（最后几行）
read_file("log/development.log", offset: -100)
```

### 4. glob_file_search（文件搜索）

**适用场景**：
- 查找特定类型的文件
- 查找模板文件
- 查找配置文件

**示例**：

```ruby
# 查找所有视图文件
glob_file_search("**/*.erb", target_directory: "app/views")

# 查找所有测试文件
glob_file_search("**/*_test.rb", target_directory: "test/")

# 查找所有迁移文件
glob_file_search("**/*.rb", target_directory: "db/migrate")
```

### 5. run_terminal_cmd（运行命令）

**适用场景**：
- 运行测试
- 检查语法错误
- 查看命令输出

**示例**：

```ruby
# 运行测试
run_terminal_cmd("bin/rails test test/models/user_test.rb")

# 检查路由
run_terminal_cmd("bin/rails routes | grep users")

# 检查语法
run_terminal_cmd("bin/rubocop app/models/user.rb")
```

## 分析错误堆栈

### 理解堆栈跟踪

**堆栈跟踪结构**：
```
ErrorClass: Error message
  from /path/to/file.rb:line_number:in `method_name'
  from /path/to/file.rb:line_number:in `another_method'
  ...
```

**分析步骤**：

1. **识别错误类型**：`ActiveRecord::RecordNotFound`、`ActionPolicy::Unauthorized` 等
2. **找到错误位置**：第一个应用代码文件（通常是 `app/` 目录下的文件）
3. **理解调用链**：从控制器 → 模型 → 数据库
4. **查看相关代码**：读取错误发生的文件和行号附近的代码

### 常见错误模式

**1. 记录不存在**：
```
ActiveRecord::RecordNotFound: Couldn't find User with 'id'=123
```

**排查**：
- 检查 `find` 调用是否应该使用 `find_by` 或添加错误处理
- 检查数据是否存在
- 检查参数是否正确传递

**2. 验证失败**：
```
ActiveRecord::RecordInvalid: Validation failed: Email has already been taken
```

**排查**：
- 查看模型的 `validates` 规则
- 检查数据是否满足验证条件
- 查看错误消息中的具体字段

**3. 权限不足**：
```
ActionPolicy::Unauthorized: not allowed to show? this User
```

**排查**：
- 查看权限策略文件
- 检查 `authorize` 调用
- 查看当前用户和资源的关系

## 分析日志

### 日志格式

**Rails 日志格式**：
```
[timestamp] [level] [tag] message
```

**示例**：
```
2024-01-01 12:00:00 INFO [User] Processing user 123
2024-01-01 12:00:01 ERROR [ActiveRecord] Record not found
```

### 分析日志内容

**查找错误**：
```ruby
# 搜索错误日志
grep("ERROR", path: "log/development.log")
grep("FATAL", path: "log/development.log")
```

**查找特定功能**：
```ruby
# 搜索认证相关日志
grep("authentication", path: "log/development.log", -i: true)

# 搜索特定用户
grep("user_id: 123", path: "log/development.log")
```

**分析 SQL 查询**：
```ruby
# 查找所有 SQL 查询
grep("SELECT", path: "log/development.log")

# 查找慢查询（如果记录了执行时间）
grep("\(.*ms\)", path: "log/development.log")
```

## 提供调试建议

### 1. 明确问题

**分析错误**：
- 错误类型和消息
- 错误发生的位置
- 可能的原因

**提供信息**：
- 错误堆栈的关键部分
- 相关代码片段
- 可能的原因分析

### 2. 提供解决方案

**代码修复**：
- 提供具体的代码修改建议
- 使用 search_replace 或 write 工具修改代码
- 说明修改的原因

**配置调整**：
- 指出需要修改的配置文件
- 提供配置示例
- 说明配置的作用

### 3. 预防措施

**最佳实践**：
- 建议添加错误处理
- 建议添加验证
- 建议添加测试

**代码改进**：
- 建议使用更安全的方法（如 `find_by` 而不是 `find`）
- 建议添加日志记录
- 建议优化性能

## 项目特定调试

### 认证系统调试

**相关文件**：
- `app/controllers/concerns/authentication.rb`
- `app/controllers/sessions_controller.rb`
- `app/models/user.rb`
- `app/policies/user_policy.rb`

**常见问题**：
- 登录失败：检查密码验证、用户状态
- 权限不足：检查权限策略、角色配置
- Session 问题：检查 session 配置、cookie 设置

### 邮件系统调试

**相关文件**：
- `app/mailers/users_mailer.rb`
- `app/mailers/passwords_mailer.rb`
- `config/initializers/200_action_mailer.rb`

**常见问题**：
- 邮件未发送：检查邮件配置、SMTP 设置
- 邮件格式错误：检查模板文件、变量传递
- 邮件队列问题：检查后台任务配置

### 缓存系统调试

**相关文件**：
- `config/environments/development.rb`
- `config/cache.yml`
- 使用缓存的控制器和模型

**常见问题**：
- 缓存未生效：检查缓存配置、缓存键
- 缓存未失效：检查依赖关系、touch 方法
- 缓存性能问题：检查缓存大小、过期时间

## 注意事项

1. **不要假设**：基于实际代码和日志分析，不要假设问题原因
2. **系统性排查**：从多个角度分析问题（代码、日志、配置、数据）
3. **提供具体方案**：不仅指出问题，还要提供具体的修复代码
4. **考虑上下文**：理解代码的业务逻辑和执行流程
5. **检查依赖**：检查相关的模型、控制器、视图、配置

## 相关资源

- **官方文档**：https://guides.rubyonrails.org/debugging_rails_applications.html
- **Rails 错误处理**：https://guides.rubyonrails.org/action_controller_overview.html#rescue
- **ActiveRecord 查询**：https://guides.rubyonrails.org/active_record_querying.html
- **Rails 日志**：https://guides.rubyonrails.org/debugging_rails_applications.html#log-tags
