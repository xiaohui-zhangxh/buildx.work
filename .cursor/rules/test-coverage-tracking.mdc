---
description: 测试覆盖率任务清单管理规则和最佳实践。创建和管理测试覆盖率任务清单文件，跟踪测试用例开发进度、覆盖率状态和优先级。完善测试用例时参考此规则。
alwaysApply: false
---

# 测试覆盖率任务清单管理规则

## 概述

为了提高测试用例的开发效率，需要在一个单独文件中记录测试覆盖率任务清单。这个清单用于跟踪哪些文件需要测试、是否有对应的测试文件、测试用例是否完善、测试覆盖率是多少，以及完善测试文件的优先级。

**官方文档**：测试覆盖率要求详见 `docs/DEVELOPER_GUIDE.md` 测试规范章节

## 核心原则

1. **集中管理**：所有测试覆盖率任务集中在一个文件中管理
2. **及时更新**：每次完善测试用例后，及时更新任务清单
3. **优先级驱动**：按照优先级顺序完善测试用例
4. **数据驱动**：基于覆盖率数据文件分析，而不是假设

## 任务清单文件位置

### 文件位置

测试覆盖率任务清单文件应该存放在项目根目录或 `docs/` 目录下，文件名为 `TEST_COVERAGE_TASKS.md`。

**推荐位置**：
- `TEST_COVERAGE_TASKS.md`（项目根目录）
- `docs/TEST_COVERAGE_TASKS.md`（文档目录）

### 文件命名

- ✅ **推荐**：`TEST_COVERAGE_TASKS.md`
- ✅ **可选**：`docs/test-coverage-tasks.md`（如果放在文档目录）
- ❌ **不推荐**：`test_coverage_tasks.md`（使用下划线）

## 任务清单文件格式

### 基本结构

```markdown
# 测试覆盖率任务清单

## 📊 整体覆盖率统计

- **目标覆盖率**：85%
- **当前覆盖率**：[从 coverage/.last_run.json 获取]
- **最后更新时间**：[日期]

## 📋 任务清单

### 高优先级

| 文件路径 | 测试文件 | 测试状态 | 覆盖率 | 优先级 | 备注 |
|---------|---------|---------|--------|--------|------|
| `app/models/user.rb` | ✅ `test/models/user_test.rb` | ✅ 完善 | 95% | P0 | 核心模型 |
| `app/controllers/sessions_controller.rb` | ✅ `test/controllers/sessions_controller_test.rb` | ⚠️ 部分 | 70% | P0 | 需要添加错误处理测试 |

### 中优先级

| 文件路径 | 测试文件 | 测试状态 | 覆盖率 | 优先级 | 备注 |
|---------|---------|---------|--------|--------|------|
| `app/helpers/application_helper.rb` | ❌ 无 | ❌ 未开始 | 0% | P1 | 辅助方法 |

### 低优先级

| 文件路径 | 测试文件 | 测试状态 | 覆盖率 | 优先级 | 备注 |
|---------|---------|---------|--------|--------|------|
| `app/mailers/users_mailer.rb` | ✅ `test/mailers/users_mailer_test.rb` | ⚠️ 部分 | 60% | P2 | 邮件模板测试 |

## 📝 更新记录

### 2025-01-XX
- ✅ 完善 `app/models/user.rb` 测试，覆盖率从 70% 提升到 95%
- ⚠️ 发现 `app/controllers/sessions_controller.rb` 缺少错误处理测试

## 🔍 如何获取覆盖率数据

### 1. 运行测试生成覆盖率报告

```bash
# 运行所有测试
bin/rails test

# 运行特定测试
bin/rails test test/models/user_test.rb
```

### 2. 读取覆盖率数据文件

**AI 分析覆盖率数据**（必须读取 JSON 文件）：

```bash
# 读取整体覆盖率信息
read_file("coverage/.last_run.json")

# 读取详细覆盖率数据
read_file("coverage/.resultset.json")
```

**用户查看覆盖率报告**：

```bash
# 在浏览器中打开 HTML 报告
open coverage/index.html
```

### 3. 分析覆盖率数据

从 `coverage/.resultset.json` 文件中可以获取：
- 每个文件的覆盖率百分比
- 未覆盖的代码行号
- 覆盖的代码行号

从 `coverage/.last_run.json` 文件中可以获取：
- 整体覆盖率百分比
- 最后运行时间
- 统计信息

## 任务清单字段说明

### 文件路径

**格式**：使用代码引用格式，例如 `` `app/models/user.rb` ``

**说明**：
- 必须是相对于项目根目录的路径
- 只包含需要测试的源代码文件（`app/` 目录下的文件）
- 不包括测试文件本身

### 测试文件

**状态标识**：
- ✅ **有测试文件**：`test/models/user_test.rb`
- ❌ **无测试文件**：无

**说明**：
- 如果存在测试文件，显示测试文件路径
- 如果不存在测试文件，显示"无"或"❌ 无"

### 测试状态

**状态标识**：
- ✅ **完善**：测试用例已经完善，覆盖了主要功能
- ⚠️ **部分**：测试用例部分完善，还需要添加更多测试
- ❌ **未开始**：还没有开始编写测试用例
- 🔄 **进行中**：正在完善测试用例

**判断标准**：
- **完善**：覆盖率 ≥ 85%，且覆盖了主要功能路径
- **部分**：覆盖率 < 85%，或缺少关键功能测试
- **未开始**：没有测试文件，或测试文件为空

### 覆盖率

**格式**：百分比，例如 `95%`、`70%`

**数据来源**：
- 从 `coverage/.resultset.json` 文件中获取
- 每次更新任务清单时，需要重新读取覆盖率数据

**说明**：
- 如果文件没有测试，覆盖率为 `0%`
- 如果文件有测试但覆盖率未知，可以标记为 `?%` 或 `待检查`

### 优先级

**优先级标识**：
- **P0**：高优先级（核心功能、关键路径）
- **P1**：中优先级（重要功能、常用功能）
- **P2**：低优先级（辅助功能、边缘情况）

**优先级判断标准**：

**P0 - 高优先级**：
- 核心业务逻辑（如 User 模型、认证控制器）
- 安全相关功能（如密码加密、权限检查）
- 关键业务流程（如登录、注册、支付）

**P1 - 中优先级**：
- 重要功能模块（如邮件发送、文件上传）
- 常用辅助方法（如 Helper 方法）
- 数据验证逻辑

**P2 - 低优先级**：
- 边缘情况处理
- 辅助工具类
- 非关键功能

### 备注

**内容**：
- 说明为什么需要测试这个文件
- 记录测试中的特殊注意事项
- 记录已知的问题或限制

**示例**：
- "核心模型，必须完善测试"
- "需要添加错误处理测试"
- "邮件模板测试，需要 mock 邮件服务"

## 创建任务清单的步骤

### 1. 创建任务清单文件

在项目根目录或 `docs/` 目录下创建 `TEST_COVERAGE_TASKS.md` 文件。

### 2. 获取覆盖率数据

**AI 应该执行**：

```bash
# 读取整体覆盖率信息
read_file("coverage/.last_run.json")

# 读取详细覆盖率数据
read_file("coverage/.resultset.json")
```

**分析数据**：
- 从 `.last_run.json` 获取整体覆盖率
- 从 `.resultset.json` 获取每个文件的覆盖率

### 3. 列出需要测试的文件

**获取需要测试的文件列表**：

```bash
# 查找所有源代码文件
glob_file_search("**/*.rb", target_directory: "app/")

# 查找所有测试文件
glob_file_search("**/*_test.rb", target_directory: "test/")
```

**匹配测试文件**：
- 对于每个源代码文件，检查是否存在对应的测试文件
- 例如：`app/models/user.rb` → `test/models/user_test.rb`

### 4. 填充任务清单

对于每个需要测试的文件，填充以下信息：
- 文件路径
- 测试文件（是否存在）
- 测试状态（从覆盖率数据判断）
- 覆盖率（从覆盖率数据获取）
- 优先级（根据文件重要性判断）
- 备注（说明测试需求）

### 5. 按优先级排序

将任务清单按优先级排序：
- 高优先级（P0）在最前面
- 中优先级（P1）在中间
- 低优先级（P2）在最后面

## 更新任务清单的步骤

### 1. 完善测试用例后更新

**步骤**：

1. **运行测试**：
   ```bash
   bin/rails test
   ```

2. **读取新的覆盖率数据**：
   ```bash
   read_file("coverage/.last_run.json")
   read_file("coverage/.resultset.json")
   ```

3. **更新任务清单**：
   - 更新对应文件的测试状态
   - 更新覆盖率百分比
   - 如果测试已完善，可以将任务移到"已完成"部分或标记为 ✅

4. **记录更新**：
   - 在"更新记录"部分添加更新日志
   - 记录更新的日期和内容

### 2. 定期更新（建议每周）

**步骤**：

1. **运行测试生成最新覆盖率报告**：
   ```bash
   bin/rails test
   ```

2. **读取覆盖率数据**：
   ```bash
   read_file("coverage/.last_run.json")
   read_file("coverage/.resultset.json")
   ```

3. **更新任务清单**：
   - 更新整体覆盖率统计
   - 更新每个文件的覆盖率
   - 更新测试状态
   - 调整优先级（如果需要）

4. **更新最后更新时间**：
   - 更新"最后更新时间"字段

## 使用任务清单完善测试用例

### 1. 选择任务

**按照优先级选择**：
- 优先处理 P0 任务
- 然后处理 P1 任务
- 最后处理 P2 任务

**考虑因素**：
- 优先级
- 覆盖率差距（距离 85% 目标还有多少）
- 文件重要性
- 开发进度

### 2. 分析测试需求

**查看任务清单中的备注**：
- 了解需要测试的功能
- 了解已知的问题或限制

**分析源代码文件**：
```bash
read_file("app/models/user.rb")
```

**分析现有测试文件**（如果存在）：
```bash
read_file("test/models/user_test.rb")
```

**分析覆盖率数据**：
- 从 `coverage/.resultset.json` 查看未覆盖的代码行
- 了解哪些代码路径需要测试

### 3. 编写测试用例

**编写测试用例**：
- 参考现有测试文件的风格
- 覆盖主要功能路径
- 覆盖错误处理路径
- 覆盖边界情况

### 4. 运行测试验证

**运行测试**：
```bash
# 运行特定测试文件
bin/rails test test/models/user_test.rb

# 检查特定文件的覆盖率
COVERAGE_FILES=app/models/user.rb bin/rails test test/models/user_test.rb
```

**验证覆盖率提升**：
- 读取新的覆盖率数据
- 确认覆盖率是否提升
- 确认是否达到目标（85%）

### 5. 更新任务清单

**更新任务清单**：
- 更新测试状态
- 更新覆盖率
- 如果测试已完善，标记为 ✅
- 在更新记录中添加日志

## 任务清单示例

### 完整示例

```markdown
# 测试覆盖率任务清单

## 📊 整体覆盖率统计

- **目标覆盖率**：85%
- **当前覆盖率**：72.5%
- **最后更新时间**：2025-01-15

## 📋 任务清单

### 高优先级（P0）

| 文件路径 | 测试文件 | 测试状态 | 覆盖率 | 优先级 | 备注 |
|---------|---------|---------|--------|--------|------|
| `app/models/user.rb` | ✅ `test/models/user_test.rb` | ⚠️ 部分 | 70% | P0 | 核心模型，需要添加验证测试 |
| `app/controllers/sessions_controller.rb` | ✅ `test/controllers/sessions_controller_test.rb` | ⚠️ 部分 | 65% | P0 | 需要添加错误处理测试 |
| `app/controllers/application_controller.rb` | ✅ `test/controllers/application_controller_test.rb` | ✅ 完善 | 90% | P0 | 已完成 |

### 中优先级（P1）

| 文件路径 | 测试文件 | 测试状态 | 覆盖率 | 优先级 | 备注 |
|---------|---------|---------|--------|--------|------|
| `app/helpers/application_helper.rb` | ❌ 无 | ❌ 未开始 | 0% | P1 | 辅助方法，需要创建测试文件 |
| `app/mailers/users_mailer.rb` | ✅ `test/mailers/users_mailer_test.rb` | ⚠️ 部分 | 60% | P1 | 邮件模板测试 |

### 低优先级（P2）

| 文件路径 | 测试文件 | 测试状态 | 覆盖率 | 优先级 | 备注 |
|---------|---------|---------|--------|--------|------|
| `app/helpers/installation_helper.rb` | ❌ 无 | ❌ 未开始 | 0% | P2 | 安装辅助方法 |

## 📝 更新记录

### 2025-01-15
- ✅ 完善 `app/controllers/application_controller.rb` 测试，覆盖率从 75% 提升到 90%
- ⚠️ 发现 `app/models/user.rb` 缺少验证测试，当前覆盖率 70%

### 2025-01-10
- ✅ 创建任务清单文件
- 📊 初始整体覆盖率：68.5%
```

## 注意事项

1. **数据准确性**：任务清单中的覆盖率数据必须从覆盖率数据文件中获取，不要假设或猜测
2. **及时更新**：每次完善测试用例后，及时更新任务清单
3. **优先级调整**：根据项目进度和需求变化，及时调整优先级
4. **不要过度追求 100%**：85% 是整体项目的覆盖率要求，不是每个文件都必须达到 100%
5. **关注核心功能**：优先完善核心业务逻辑的测试，而不是追求每个文件的完美覆盖率

## 相关文件索引

- **测试覆盖率要求**：`docs/DEVELOPER_GUIDE.md`（测试规范章节）
- **测试配置**：`test/test_helper.rb`
- **覆盖率数据文件**：
  - `coverage/.last_run.json`（整体覆盖率信息）
  - `coverage/.resultset.json`（详细覆盖率数据）
- **测试覆盖率任务清单**：`TEST_COVERAGE_TASKS.md`（项目根目录）或 `docs/TEST_COVERAGE_TASKS.md`
