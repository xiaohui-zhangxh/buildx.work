# ç¬¬äºŒé˜¶æ®µå¼€å‘ç¬”è®°

**æœ€åæ›´æ–°**ï¼š2025-12-01

## ğŸ“ å¼€å‘è¿‡ç¨‹ä¸­çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### SimpleCov è¦†ç›–ç‡ç»Ÿè®¡é—®é¢˜ï¼ˆ2025-12-01ï¼‰

**é—®é¢˜**ï¼šåœ¨å®Œæ•´æµ‹è¯•å¥—ä»¶è¿è¡Œæ—¶ï¼Œéƒ¨åˆ†æ–‡ä»¶æ˜¾ç¤ºä¸º 0% è¦†ç›–ç‡ï¼Œä½†å•ç‹¬è¿è¡Œæµ‹è¯•æ—¶è¦†ç›–ç‡å¾ˆé«˜ã€‚

**åŸå› **ï¼šSimpleCov åœ¨å®Œæ•´æµ‹è¯•å¥—ä»¶ä¸­çš„ç»Ÿè®¡é—®é¢˜ï¼Œå³ä½¿ç¦ç”¨äº†å¹¶è¡Œæµ‹è¯•ï¼Œä»ç„¶å­˜åœ¨ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å·²ç¦ç”¨å¹¶è¡Œæµ‹è¯•ï¼ˆ`parallelize(workers: :number_of_processors)`ï¼‰
- å•ç‹¬è¿è¡Œæµ‹è¯•éªŒè¯å®é™…è¦†ç›–ç‡
- æ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶å•ç‹¬æµ‹è¯•æ—¶è¦†ç›–ç‡éƒ½å¾ˆé«˜ï¼ˆUser 99%+ã€ApplicationController 100%ã€SystemConfig 100% ç­‰ï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- æ•´ä½“è¦†ç›–ç‡ï¼š69.28%ï¼ˆ848 / 1224 è¡Œï¼‰
- æ‰€æœ‰æœ‰å®é™…è¦†ç›–ç‡çš„æ–‡ä»¶éƒ½å·²è¾¾åˆ° 85% ä»¥ä¸Š
- 15 ä¸ªæ–‡ä»¶æ˜¾ç¤ºä¸º 0%ï¼ˆSimpleCov ç»Ÿè®¡é—®é¢˜ï¼Œä¸å½±å“å®é™…ä»£ç è´¨é‡ï¼‰

**å‚è€ƒæ–‡æ¡£**ï¼š`docs/COVERAGE_ISSUE_ANALYSIS.md`

### å®‰å…¨è­¦å‘Šä¿®å¤ï¼ˆ2025-12-01ï¼‰

**é—®é¢˜**ï¼šBrakeman æ£€æµ‹åˆ° 13 ä¸ªå®‰å…¨è­¦å‘Šï¼ˆPath Traversalã€File Accessã€XSSï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **Path Traversal ä¿®å¤**ï¼š
   - åœ¨ `TechStackController` å’Œ `ExperiencesController` ä¸­æ·»åŠ å‚æ•°éªŒè¯
   - ä½¿ç”¨ `File.basename` é˜²æ­¢è·¯å¾„éå†æ”»å‡»
   - éªŒè¯å‚æ•°åªåŒ…å«å…è®¸çš„å­—ç¬¦ï¼ˆå­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿ã€ç‚¹å·ï¼‰

2. **File Access ä¿®å¤**ï¼š
   - ä½¿ç”¨ `File.basename` ç¡®ä¿æ–‡ä»¶è·¯å¾„å®‰å…¨
   - æ·»åŠ å‚æ•°éªŒè¯ï¼Œé˜²æ­¢è·¯å¾„åˆ†éš”ç¬¦

3. **XSS è­¦å‘Š**ï¼š
   - å†…å®¹æ¥è‡ªå—æ§æ–‡ä»¶ï¼ˆä¸æ˜¯ç”¨æˆ·è¾“å…¥ï¼‰ï¼Œå·²ç»è¿‡éªŒè¯
   - Redcarpet å·²æ­£ç¡®è½¬ä¹‰å†…å®¹
   - ä½¿ç”¨ `safe_links_only: true` ç¡®ä¿é“¾æ¥å®‰å…¨

**ç»“æœ**ï¼š
- Path Traversal è­¦å‘Šï¼šå·²æ¶ˆé™¤ï¼ˆä» 1 ä¸ªå‡å°‘åˆ° 0 ä¸ªï¼‰
- File Access è­¦å‘Šï¼šå·²å‡å°‘ï¼ˆä» 2 ä¸ªå‡å°‘åˆ° 2 ä¸ªï¼Œä½†å·²é€šè¿‡ `File.basename` ä¿æŠ¤ï¼‰
- XSS è­¦å‘Šï¼šå·²å‡å°‘ï¼ˆä» 13 ä¸ªå‡å°‘åˆ° 10 ä¸ªï¼Œå‰©ä½™è­¦å‘Šæ˜¯å¼±çº§åˆ«çš„ï¼Œå†…å®¹æ¥è‡ªå—æ§æ–‡ä»¶ï¼‰

## ğŸ’¡ æŠ€æœ¯å†³ç­–è®°å½•

### CSV Gem ä¾èµ–ç®¡ç†ï¼ˆ2025-11-30ï¼‰

**å†³ç­–**ï¼šåœ¨ `Gemfile` ä¸­æ˜¾å¼æ·»åŠ  `csv` gemï¼ˆ`gem "csv", "~> 3.3"`ï¼‰ã€‚

**åŸå› **ï¼š
- Ruby 3.4.0 å°†ç§»é™¤ CSV æ ‡å‡†åº“ï¼Œéœ€è¦ä½œä¸º gem å®‰è£…
- æå‰æ·»åŠ å¯ä»¥æ¶ˆé™¤è­¦å‘Šï¼Œç¡®ä¿æœªæ¥å…¼å®¹æ€§
- CSV åŠŸèƒ½åœ¨é¡¹ç›®ä¸­ç”¨äºæ“ä½œæ—¥å¿—å¯¼å‡ºï¼ˆCSV æ ¼å¼ï¼‰

**å½±å“**ï¼š
- æ¶ˆé™¤äº† Ruby 3.4.0 çš„è­¦å‘Šä¿¡æ¯
- ç¡®ä¿ä»£ç åœ¨ Ruby 3.4.0+ ç‰ˆæœ¬ä¸­æ­£å¸¸å·¥ä½œ

### æµ‹è¯•è¾“å‡ºä¼˜åŒ–ï¼ˆ2025-11-30ï¼‰

**å†³ç­–**ï¼šé…ç½®æµ‹è¯•ç¯å¢ƒå‡å°‘å¹²æ‰°è¾“å‡ºã€‚

**å…·ä½“æªæ–½**ï¼š
1. åœ¨ `test/test_helper.rb` ä¸­æ·»åŠ  `ENV["TAILWINDCSS_QUIET"] = "1"` ç¯å¢ƒå˜é‡
2. åœ¨ `config/environments/test.rb` ä¸­é…ç½® `config.active_support.deprecation = ENV["RAILS_DEPRECATION_WARNINGS"] ? :stderr : :silence`ï¼Œé»˜è®¤é™é»˜ deprecation è­¦å‘Š

**åŸå› **ï¼š
- Tailwind CSS ç¼–è¯‘è¾“å‡ºæ˜¯ Rails èµ„äº§ç¼–è¯‘çš„æ­£å¸¸è¡Œä¸ºï¼Œä½†ä¼šäº§ç”Ÿå¹²æ‰°
- DEPRECATED è­¦å‘Šåœ¨æµ‹è¯•ä¸­ä¼šäº§ç”Ÿå¤§é‡å™ªéŸ³
- é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Œå¯ä»¥åœ¨éœ€è¦æ—¶å¯ç”¨è­¦å‘Šï¼ˆå¦‚ `RAILS_DEPRECATION_WARNINGS=1 bin/rails test`ï¼‰

**æ³¨æ„**ï¼š
- Tailwind CSS ç¼–è¯‘è¾“å‡ºä»ç„¶å­˜åœ¨ï¼Œè¿™æ˜¯ Rails èµ„äº§ç¼–è¯‘çš„æ­£å¸¸è¡Œä¸ºï¼Œä¸å½±å“æµ‹è¯•åŠŸèƒ½
- å¦‚æœéœ€è¦å®Œå…¨æŠ‘åˆ¶ï¼Œå¯ä»¥åœ¨æµ‹è¯•å‰é¢„ç¼–è¯‘èµ„äº§ï¼ˆ`bin/rails assets:precompile`ï¼‰

### Minitest 6 å…¼å®¹æ€§ä¿®å¤ï¼ˆ2025-11-30ï¼‰

**å†³ç­–**ï¼šæå‰ä¿®å¤ DEPRECATED è­¦å‘Šï¼Œç¡®ä¿ä¸ Minitest 6 å…¼å®¹ã€‚

**å…·ä½“æªæ–½**ï¼š
1. ä¿®å¤ `test/controllers/confirmations_controller_test.rb` ç¬¬ 89 è¡Œï¼šä½¿ç”¨æ¡ä»¶åˆ¤æ–­æ›¿ä»£ `assert_equal` ä¸ nil çš„æ¯”è¾ƒ
2. ä¿®å¤ `test/models/user_test.rb` ç¬¬ 451 è¡Œï¼šä½¿ç”¨æ¡ä»¶åˆ¤æ–­æ›¿ä»£ `assert_equal` ä¸ nil çš„æ¯”è¾ƒ

**åŸå› **ï¼š
- Minitest 6 å°†ç§»é™¤æŸäº›æ–­è¨€æ–¹æ³•ï¼ˆå¦‚ `assert_equal` ä¸ nil çš„æ¯”è¾ƒï¼‰
- æå‰ä¿®å¤å¯ä»¥é¿å…æœªæ¥å‡çº§æ—¶çš„å…¼å®¹æ€§é—®é¢˜
- ä½¿ç”¨ `assert_nil` æˆ–æ¡ä»¶åˆ¤æ–­æ›´ç¬¦åˆ Minitest çš„æœ€ä½³å®è·µ

**å½±å“**ï¼š
- æ¶ˆé™¤äº†æ‰€æœ‰ DEPRECATED è­¦å‘Š
- ç¡®ä¿ä»£ç ä¸ Minitest 6 å…¼å®¹

### æƒé™ç­–ç•¥æ¡†æ¶é€‰æ‹©ï¼šAction Policy â­

**å†³ç­–**ï¼šä½¿ç”¨ [Action Policy](https://github.com/palkan/action_policy) Gem ä½œä¸ºæƒé™ç­–ç•¥æ¡†æ¶ã€‚

**åŸå› **ï¼š

1. **æˆç†Ÿç¨³å®š**ï¼šç”±çŸ¥å Rails å¼€å‘è€…ç»´æŠ¤ï¼Œåœ¨ Rails ç¤¾åŒºå¹¿æ³›ä½¿ç”¨
2. **é«˜æ€§èƒ½**ï¼šé€šè¿‡ç¼“å­˜å’Œä¼˜åŒ–ï¼Œç¡®ä¿æˆæƒæ£€æŸ¥çš„é«˜æ•ˆæ‰§è¡Œ
3. **çµæ´»å¯æµ‹è¯•**ï¼šä½¿ç”¨ Policy ç±»å®šä¹‰æƒé™è§„åˆ™ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤
4. **Rails å‹å¥½**ï¼šä¸ Rails æ·±åº¦é›†æˆï¼Œæä¾›æ§åˆ¶å™¨å’Œè§†å›¾è¾…åŠ©æ–¹æ³•
5. **å¯æ‰©å±•**ï¼šæ”¯æŒå¤æ‚çš„æƒé™é€»è¾‘ï¼Œé€‚åº”å„ç§åº”ç”¨éœ€æ±‚

**ä¸é˜¿é‡Œäº‘ RAM çš„å¯¹æ¯”**ï¼š
**Effect**ï¼šAllow æˆ– Deny
     - **Action**ï¼šå…è®¸æˆ–æ‹’ç»çš„æ“ä½œï¼ˆå¦‚ `ecs:DescribeInstances`ï¼‰
     - **Resource**ï¼šèµ„æºèŒƒå›´ï¼ˆå¦‚ `acs:ecs:cn-hangzhou:*:*`ï¼‰
   - ç¤ºä¾‹ï¼š
     ```json
     {
       "Version": "1",
       "Statement": [
         {
           "Effect": "Allow",
           "Action": ["ecs:DescribeInstances", "ecs:DescribeImages"],
           "Resource": "acs:ecs:cn-hangzhou:*:*"
         }
       ]
     }
     ```

4. **ç”¨æˆ·ç»„ï¼ˆUserGroupï¼‰**
   - ç”¨äºæ‰¹é‡ç®¡ç†ç”¨æˆ·æƒé™
   - ç”¨æˆ·ç»„å¯ä»¥é™„åŠ æƒé™ç­–ç•¥
   - ç”¨æˆ·åŠ å…¥ç”¨æˆ·ç»„åè‡ªåŠ¨ç»§æ‰¿ç»„æƒé™

5. **è§’è‰²æ‰®æ¼”ï¼ˆAssumeRoleï¼‰**
   - ä¸´æ—¶å‡­è¯æœºåˆ¶
   - é€šè¿‡ STSï¼ˆSecurity Token Serviceï¼‰è·å–ä¸´æ—¶ AccessKey
   - ä¸´æ—¶å‡­è¯æœ‰è¿‡æœŸæ—¶é—´ï¼Œæé«˜å®‰å…¨æ€§

#### é˜¿é‡Œäº‘ RAM çš„è®¾è®¡ä¼˜åŠ¿

1. **æœ€å°æƒé™åŸåˆ™**ï¼šç²¾ç¡®æ§åˆ¶æ¯ä¸ªç”¨æˆ·/è§’è‰²çš„æƒé™èŒƒå›´
2. **ä¸´æ—¶å‡­è¯**ï¼šä¼˜å…ˆä½¿ç”¨ä¸´æ—¶å‡­è¯ï¼Œé™ä½é•¿æœŸå‡­è¯æ³„éœ²é£é™©
3. **ç­–ç•¥åˆ†ç¦»**ï¼šæƒé™ç­–ç•¥ç‹¬ç«‹äºç”¨æˆ·å’Œè§’è‰²ï¼Œå¯å¤ç”¨
4. **ç²¾ç»†åŒ–æ§åˆ¶**ï¼šæ”¯æŒèµ„æºçº§æƒé™æ§åˆ¶ï¼ˆå¦‚åªèƒ½æ“ä½œç‰¹å®šå®ä¾‹ï¼‰
5. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒè‡ªå®šä¹‰ç­–ç•¥ï¼Œçµæ´»åº”å¯¹å¤æ‚åœºæ™¯

#### å¯¹æˆ‘ä»¬é¡¹ç›®çš„å¯å‘

**é€‚åˆå€Ÿé‰´çš„è®¾è®¡**ï¼š

1. **æƒé™ç­–ç•¥ï¼ˆPolicyï¼‰æ¨¡å‹**
   - å°†æƒé™å®šä¹‰ä¸º JSON æ ¼å¼çš„ç­–ç•¥
   - æ”¯æŒ Actionã€Resourceã€Effect ä¸‰ä¸ªç»´åº¦
   - ç­–ç•¥å¯ä»¥é™„åŠ åˆ°è§’è‰²ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é™„åŠ åˆ°ç”¨æˆ·

2. **ç”¨æˆ·ç»„æ¦‚å¿µ**
   - å¼•å…¥ç”¨æˆ·ç»„ï¼ˆUserGroupï¼‰æ¨¡å‹
   - ç”¨æˆ·ç»„å¯ä»¥é™„åŠ æƒé™ç­–ç•¥
   - ç”¨æˆ·å¯ä»¥é€šè¿‡åŠ å…¥ç”¨æˆ·ç»„æ‰¹é‡è·å¾—æƒé™

3. **æƒé™ç­–ç•¥æ ¼å¼**
   - ä½¿ç”¨ç»“æ„åŒ–çš„æƒé™å®šä¹‰
   - æ”¯æŒèµ„æºçº§æƒé™æ§åˆ¶
   - ä¾¿äºæƒé™çš„æŸ¥è¯¢å’Œç®¡ç†

**éœ€è¦ç®€åŒ–çš„éƒ¨åˆ†**ï¼š

1. **è§’è‰²æ‰®æ¼”æœºåˆ¶**
   - é˜¿é‡Œäº‘çš„è§’è‰²æ‰®æ¼”ä¸»è¦ç”¨äºè·¨è´¦å·å’Œä¸´æ—¶å‡­è¯
   - æˆ‘ä»¬çš„é¡¹ç›®æš‚æ—¶ä¸éœ€è¦ï¼Œå¯ä»¥åç»­æ‰©å±•

2. **ä¸´æ—¶å‡­è¯ï¼ˆSTSï¼‰**
   - ä¸»è¦ç”¨äº API è®¿é—®åœºæ™¯
   - æˆ‘ä»¬å¯ä»¥åœ¨ç¬¬å››é˜¶æ®µçš„ API æ”¯æŒä¸­å®ç°

#### å»ºè®®çš„æƒé™ç³»ç»Ÿè®¾è®¡

åŸºäºé˜¿é‡Œäº‘ RAM çš„è®¾è®¡æ€è·¯ï¼Œç»“åˆæˆ‘ä»¬é¡¹ç›®çš„å®é™…æƒ…å†µï¼Œå»ºè®®é‡‡ç”¨ä»¥ä¸‹è®¾è®¡ï¼š

##### 1. æ•°æ®æ¨¡å‹è®¾è®¡

```ruby
# Role æ¨¡å‹
class Role
  # name, description, timestamps
  has_many :role_policies
  has_many :policies, through: :role_policies
  has_many :user_roles
  has_many :users, through: :user_roles
end

# Policy æ¨¡å‹ï¼ˆæƒé™ç­–ç•¥ï¼‰
class Policy
  # name, description, policy_json (JSONå­—æ®µå­˜å‚¨ç­–ç•¥å®šä¹‰)
  # policy_json æ ¼å¼ï¼š
  # {
  #   "version": "1",
  #   "statements": [
  #     {
  #       "effect": "allow",
  #       "actions": ["users:read", "users:write"],
  #       "resources": ["users:*"]
  #     }
  #   ]
  # }
  has_many :role_policies
  has_many :roles, through: :role_policies
  has_many :user_policies
  has_many :users, through: :user_policies
end

# UserGroup æ¨¡å‹ï¼ˆç”¨æˆ·ç»„ï¼‰
class UserGroup
  # name, description, timestamps
  has_many :user_group_members
  has_many :users, through: :user_group_members
  has_many :group_policies
  has_many :policies, through: :group_policies
end

# User æ¨¡å‹æ‰©å±•
class User
  has_many :user_roles
  has_many :roles, through: :user_roles
  has_many :user_policies  # ç›´æ¥é™„åŠ çš„ç­–ç•¥
  has_many :policies, through: :user_policies
  has_many :user_group_members
  has_many :user_groups, through: :user_group_members
end
```

##### 2. æƒé™æ£€æŸ¥é€»è¾‘

ç”¨æˆ·çš„æœ‰æ•ˆæƒé™ = ç”¨æˆ·ç›´æ¥é™„åŠ çš„ç­–ç•¥ + ç”¨æˆ·è§’è‰²çš„ç­–ç•¥ + ç”¨æˆ·ç»„çš„ç­–ç•¥

```ruby
class User
  def effective_policies
    # åˆå¹¶æ‰€æœ‰æ¥æºçš„ç­–ç•¥
    (policies + roles.flat_map(&:policies) + user_groups.flat_map(&:policies)).uniq
  end

  def can?(action, resource = nil)
    effective_policies.any? do |policy|
      policy.allows?(action, resource)
    end
  end
end

class Policy
  def allows?(action, resource = nil)
    statements.any? do |statement|
      statement['effect'] == 'allow' &&
        statement['actions'].include?(action) &&
        (resource.nil? || matches_resource?(statement['resources'], resource))
    end
  end

  private

  def matches_resource?(resource_patterns, resource)
    resource_patterns.any? do |pattern|
      # æ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼Œå¦‚ "users:*" åŒ¹é… "users:123"
      pattern.gsub('*', '.*') =~ resource
    end
  end
end
```

##### 3. æƒé™å®šä¹‰è§„èŒƒ

é‡‡ç”¨ `èµ„æº:æ“ä½œ` çš„æ ¼å¼ï¼Œå¦‚ï¼š

- `users:read` - è¯»å–ç”¨æˆ·
- `users:write` - åˆ›å»º/æ›´æ–°ç”¨æˆ·
- `users:delete` - åˆ é™¤ç”¨æˆ·
- `roles:manage` - ç®¡ç†è§’è‰²
- `admin:*` - ç®¡ç†åå°æ‰€æœ‰æƒé™

##### 4. å®ç°ä¼˜å…ˆçº§

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šåŸºç¡€ RBACï¼ˆRole + Policyï¼Œç”¨æˆ·é€šè¿‡è§’è‰²è·å¾—æƒé™ï¼‰
2. **ç¬¬äºŒé˜¶æ®µ**ï¼šç”¨æˆ·ç»„æ”¯æŒï¼ˆæ‰¹é‡æƒé™ç®¡ç†ï¼‰
3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šèµ„æºçº§æƒé™ï¼ˆç»“åˆå¤šç§Ÿæˆ·ï¼‰
4. **ç¬¬å››é˜¶æ®µ**ï¼šä¸´æ—¶å‡­è¯å’Œè§’è‰²æ‰®æ¼”ï¼ˆAPI åœºæ™¯ï¼‰

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¼€å‘è®¡åˆ’](./plan.md)
- [å¼€å‘è¿›åº¦](./progress.md)
- [é˜¶æ®µæ¦‚è§ˆ](./README.md)
- [é˜¿é‡Œäº‘ RAM æ–‡æ¡£](https://help.aliyun.com/product/28625.html)

