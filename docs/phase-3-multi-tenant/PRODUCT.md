# 第三阶段：多租户支持 - 产品功能文档

## 📋 文档说明

本文档从**产品/用户角度**描述多租户支持功能，包括使用场景、功能特性、用户体验和业务流程。技术实现细节请参考 [开发计划](./plan.md)。

## 🎯 产品价值

### 为什么需要多租户支持？

多租户支持是 SaaS 应用的核心功能，允许一个应用实例为多个独立的组织（租户）提供服务，每个组织的数据完全隔离，互不干扰。

### 核心价值

1. **数据安全隔离**：每个租户的数据完全独立，确保数据安全和隐私
2. **独立配置管理**：每个租户可以有自己的配置和设置
3. **简化用户管理**：用户通过加入码轻松加入组织，无需复杂邀请流程
4. **灵活的组织架构**：支持企业级组织架构和团队协作
5. **成本效益**：多个组织共享同一套基础设施，降低运营成本

## 👥 目标用户

### 主要用户角色

1. **Account Owner（账户所有者）**
   - 创建和管理 Account
   - 邀请成员加入
   - 管理 Account 配置
   - 管理成员权限

2. **Account Admin（账户管理员）**
   - 管理 Account 成员
   - 分配角色和权限
   - 查看 Account 数据

3. **Account Member（账户成员）**
   - 使用 Account 功能
   - 查看和编辑自己的数据
   - 与其他成员协作

4. **系统管理员（可选）**
   - 管理所有 Account
   - 查看系统统计
   - 处理 Account 相关问题

## 📖 用户故事

### 故事 1：创建新组织（Account）

**作为** 一个企业用户  
**我想要** 创建一个新的组织 Account  
**以便于** 我的团队可以开始使用系统

**场景**：
- 用户访问注册页面
- 填写组织信息（名称、描述等）
- 填写创建者信息（姓名、邮箱、密码）
- 系统自动创建 Account 和 Owner
- 自动生成加入码（Join Code）
- 创建者自动登录并进入 Account

**验收标准**：
- ✅ Account 创建成功
- ✅ Owner 用户创建成功
- ✅ 加入码自动生成
- ✅ 创建者自动登录
- ✅ 可以立即使用 Account 功能

### 故事 2：通过加入码加入组织

**作为** 一个受邀用户  
**我想要** 通过加入码加入组织  
**以便于** 我可以访问组织的资源

**场景**：
- 用户收到加入码（如 "ABC123"）
- 访问 `/join/ABC123` 页面
- 查看组织信息（名称、描述）
- 填写个人信息（姓名、邮箱、密码）
- 提交加入请求
- 系统创建用户并关联到 Account
- 用户自动登录并进入 Account

**验收标准**：
- ✅ 加入码验证成功
- ✅ 组织信息正确显示
- ✅ 用户创建成功并关联到 Account
- ✅ 用户自动登录
- ✅ 可以访问 Account 资源

### 故事 3：切换不同的组织

**作为** 一个属于多个组织的用户  
**我想要** 在不同组织之间切换  
**以便于** 我可以访问不同组织的数据

**场景**：
- 用户登录后，在导航栏看到"切换组织"菜单
- 点击菜单，显示用户所属的所有组织列表
- 选择要切换的组织
- 系统更新当前组织上下文
- 页面刷新，显示新组织的数据

**验收标准**：
- ✅ 显示用户所属的所有组织
- ✅ 可以快速切换组织
- ✅ 切换后数据正确显示
- ✅ URL 自动更新为新的组织 Slug

### 故事 4：管理组织成员

**作为** Account Owner 或 Admin  
**我想要** 管理组织成员  
**以便于** 我可以控制谁可以访问组织资源

**场景**：
- 进入"成员管理"页面
- 查看所有成员列表
- 可以添加新成员（通过加入码或直接邀请）
- 可以编辑成员信息
- 可以分配角色和权限
- 可以移除成员

**验收标准**：
- ✅ 成员列表正确显示
- ✅ 可以添加、编辑、删除成员
- ✅ 角色分配功能正常
- ✅ 权限控制正确生效

### 故事 5：查看组织数据（数据隔离）

**作为** 一个组织成员  
**我想要** 查看组织的数据  
**以便于** 我只能看到自己组织的数据，不会看到其他组织的数据

**场景**：
- 用户登录后，访问任何数据页面
- 系统自动过滤，只显示当前组织的数据
- 即使用户知道其他组织的资源 ID，也无法访问

**验收标准**：
- ✅ 数据自动按组织过滤
- ✅ 无法访问其他组织的数据
- ✅ 跨组织访问返回 404 或 403 错误
- ✅ 查询性能良好（有索引优化）

## ✨ 功能特性

### 1. Account 创建和管理

#### 1.1 创建 Account

**功能描述**：
- 用户可以创建新的组织 Account
- 创建时需要填写组织信息和创建者信息
- 系统自动创建 Account、Owner 用户和加入码

**用户界面**：
- 创建 Account 表单页面
- 表单包含：
  - 组织名称（必填）
  - 组织描述（可选）
  - 创建者姓名（必填）
  - 创建者邮箱（必填）
  - 创建者密码（必填）
  - 确认密码（必填）

**业务流程**：
1. 用户访问 `/accounts/new` 页面
2. 填写表单信息
3. 提交表单
4. 系统验证信息
5. 创建 Account 和 Owner
6. 生成加入码
7. 自动登录创建者
8. 重定向到 Account 首页

#### 1.2 Account 信息管理

**功能描述**：
- Account Owner 可以编辑组织信息
- 可以更新组织名称和描述
- 可以查看 Account 统计信息

**用户界面**：
- Account 设置页面
- 显示 Account 基本信息
- 编辑表单
- 统计信息展示（成员数量、创建时间等）

### 2. Join Code（加入码）机制

#### 2.1 生成加入码

**功能描述**：
- 每个 Account 自动生成一个唯一的加入码
- 加入码格式：6-8 位字母数字组合（如 "ABC123"）
- 可以设置过期时间和最大使用次数

**用户界面**：
- Account 设置页面显示加入码
- 可以重新生成加入码
- 可以设置加入码过期时间
- 可以设置最大使用次数

#### 2.2 通过加入码加入

**功能描述**：
- 用户可以通过加入码加入组织
- 访问 `/join/ABC123` 页面
- 查看组织信息
- 填写个人信息并加入

**用户界面**：
- 加入页面显示组织信息
- 注册表单（如果用户未注册）
- 或登录表单（如果用户已注册）

**业务流程**：
1. 用户访问 `/join/ABC123` 页面
2. 系统验证加入码有效性
3. 显示组织信息
4. 用户填写信息并提交
5. 系统创建用户并关联到 Account
6. 使用加入码（增加使用次数）
7. 用户自动登录
8. 重定向到 Account 首页

### 3. 数据隔离

#### 3.1 自动数据过滤

**功能描述**：
- 所有数据查询自动按当前 Account 过滤
- 用户只能看到自己组织的数据
- 跨组织访问被拒绝

**用户体验**：
- 用户无需手动选择组织
- 系统自动根据当前上下文过滤数据
- 数据列表、详情页面都只显示当前组织的数据

#### 3.2 权限控制

**功能描述**：
- 权限检查考虑 Account 上下文
- 用户只能访问自己组织的资源
- 跨组织访问返回 403 错误

### 4. URL 路由设计

#### 4.1 多租户 URL 结构

**URL 格式**：`/account-slug/resource`

**示例**：
- `/acme-corp/users` - Acme Corp 组织的用户列表
- `/acme-corp/users/123` - Acme Corp 组织的用户详情
- `/acme-corp/admin` - Acme Corp 组织的管理后台

**用户体验**：
- URL 中包含组织标识，清晰明了
- 用户可以通过 URL 直接访问组织资源
- 切换组织时 URL 自动更新

#### 4.2 Account Slug

**功能描述**：
- 每个 Account 有一个唯一的 Slug
- Slug 基于外部 ID 编码生成
- Slug 用于 URL 路由和邮件链接

**示例**：
- Account 外部 ID: `12345`
- Slug: `/a1b2c3d4`（编码后的形式）

### 5. Account 切换（可选）

#### 5.1 多组织支持

**功能描述**：
- 用户可以属于多个组织
- 可以在不同组织之间切换
- 切换后数据自动更新

**用户界面**：
- 导航栏显示"切换组织"菜单
- 菜单显示用户所属的所有组织
- 当前组织高亮显示
- 点击组织名称快速切换

**业务流程**：
1. 用户点击"切换组织"菜单
2. 显示组织列表
3. 用户选择要切换的组织
4. 系统更新 `Current.account`
5. 页面刷新，显示新组织的数据
6. URL 更新为新的组织 Slug

### 6. 组织架构（可选，后续扩展）

#### 6.1 部门管理

**功能描述**：
- 支持企业组织树形结构
- 可以创建和管理部门
- 支持部门层级关系

#### 6.2 员工管理

**功能描述**：
- 可以管理组织内的员工
- 可以分配员工到部门
- 可以设置员工的角色和权限

## 🎨 用户体验设计

### 1. Account 创建页面

**设计要点**：
- 清晰的表单结构
- 组织信息和创建者信息分开显示
- 友好的错误提示
- 成功后的自动登录和跳转

**界面元素**：
- 页面标题："创建新组织"
- 表单分组：
  - "组织信息"组
  - "创建者信息"组
- 提交按钮："创建组织"
- 成功提示和自动跳转

### 2. 加入页面

**设计要点**：
- 显示组织信息（名称、描述）
- 简化的注册/登录流程
- 实时验证加入码有效性
- 友好的错误提示

**界面元素**：
- 组织信息卡片（名称、描述、Logo 等）
- 注册/登录表单
- 加入按钮："加入组织"
- 错误提示（加入码无效、已过期等）

### 3. Account 设置页面

**设计要点**：
- 清晰的设置分类
- 加入码管理区域
- 成员管理入口
- 统计信息展示

**界面元素**：
- 设置导航（基本信息、成员管理、加入码等）
- 加入码显示区域（可以复制、重新生成）
- 统计卡片（成员数量、创建时间等）
- 操作按钮（编辑、删除等）

### 4. 组织切换菜单

**设计要点**：
- 清晰的当前组织标识
- 组织列表展示
- 快速切换功能
- 视觉反馈（当前组织高亮）

**界面元素**：
- 下拉菜单或侧边栏
- 组织列表（名称、Logo、成员数量等）
- 当前组织标识（高亮或标记）
- 切换按钮或点击切换

## 🔄 业务流程

### 流程 1：新用户创建 Account

```
1. 用户访问注册页面
   ↓
2. 填写组织信息和创建者信息
   ↓
3. 提交表单
   ↓
4. 系统验证信息
   ↓
5. 创建 Account 和 Owner
   ↓
6. 生成加入码
   ↓
7. 创建系统用户
   ↓
8. 自动登录创建者
   ↓
9. 重定向到 Account 首页
```

### 流程 2：用户通过加入码加入

```
1. 用户收到加入码（如 "ABC123"）
   ↓
2. 访问 /join/ABC123 页面
   ↓
3. 系统验证加入码有效性
   ↓
4. 显示组织信息
   ↓
5. 用户填写个人信息
   ↓
6. 提交加入请求
   ↓
7. 系统创建用户并关联到 Account
   ↓
8. 使用加入码（增加使用次数）
   ↓
9. 用户自动登录
   ↓
10. 重定向到 Account 首页
```

### 流程 3：切换组织

```
1. 用户登录（属于多个组织）
   ↓
2. 点击"切换组织"菜单
   ↓
3. 显示组织列表
   ↓
4. 用户选择要切换的组织
   ↓
5. 系统更新 Current.account
   ↓
6. 页面刷新
   ↓
7. 显示新组织的数据
   ↓
8. URL 更新为新的组织 Slug
```

### 流程 4：数据查询（自动过滤）

```
1. 用户访问数据页面
   ↓
2. 系统从 URL 或 Current.account 获取 Account
   ↓
3. 设置 Current.account
   ↓
4. 查询数据时自动添加 Account 过滤条件
   ↓
5. 只返回当前组织的数据
   ↓
6. 显示给用户
```

## 📊 功能优先级

### P0（核心功能，必须实现）

1. ✅ Account 模型和基础功能
2. ✅ 外部 ID 和 Slug 支持
3. ✅ Join Code 机制
4. ✅ Current.account 管理
5. ✅ 数据隔离（所有模型关联到 Account）
6. ✅ URL 路由设计（script_name）

### P1（重要功能，建议实现）

1. ⏳ Account 创建界面
2. ⏳ 加入码加入流程
3. ⏳ Account 设置页面
4. ⏳ 数据查询自动过滤

### P2（可选功能，后续扩展）

1. ⏳ Account 切换功能（多组织支持）
2. ⏳ 组织架构管理
3. ⏳ 部门管理
4. ⏳ 员工管理

## 🔗 相关文档

- [开发计划](./plan.md) - 技术实现细节
- [开发进度](./progress.md) - 开发进度跟踪
- [开发笔记](./notes.md) - 开发笔记和问题记录
- [Fizzy SaaS 多租户 Account 设计](../experiences/fizzy-saas-account-design.md) - 参考实现

## 📝 更新记录

- **创建日期**：2025-12-04
- **最后更新**：2025-12-04

